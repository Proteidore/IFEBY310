{
  "hash": "2023a92f6a83b07e39c8b898e084c3d1",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Using with `pyspark` for data preprocessing\njupyter: python3\n---\n\n\n\n## Data description\n\nThe data is a `parquet` file which contains a dataframe with 8 columns:\n\n- `xid`: unique user id\n- `action`: type of action. 'C' is a click, 'O' or 'VSL' is a web-display\n- `date`: date of the action\n- `website_id`: unique id of the website\n- `url`: url of the webpage\n- `category_id`: id of the display\n- `zipcode`: postal zipcode of the user\n- `device`: type of device used by the user\n\n## Q1. Some statistics / computations\n\nUsing `pyspark.sql` we want to do the following things:\n\n1. Compute the total number of unique users\n2. Construct a column containing the total number of actions per user\n3. Construct a column containing the number of days since the last action of the user\n4. Construct a column containing the number of actions of each user for each modality of device \n\n## Q2. Binary classification\n\nThen, we want to construct a classifier to predict the click on the category 1204. \nHere is an agenda for this:\n\n1. Construction of a features matrix for which each line corresponds to the information concerning a user.\n2. In this matrix, we need to keep only the users that have been exposed to the display in category 1204\n3. Using this training dataset, train a binary classifier, and evaluate your classifier using a precision / recall curve computed on test data.\n\n\n# Download/read the data and a first look at the data\n\n::: {#dd2585a0 .cell execution_count=1}\n``` {.python .cell-code}\nimport os\nimport sys\n\nos.environ['PYSPARK_PYTHON'] = sys.executable\nos.environ['PYSPARK_DRIVER_PYTHON'] = sys.executable\n```\n:::\n\n\n::: {.callout-note}\n\n### Spark in local mode\n\n::: {#c16724f1 .cell execution_count=2}\n``` {.python .cell-code}\nfrom pyspark import SparkConf, SparkContext\nfrom pyspark.sql import SparkSession\n\nspark = (SparkSession\n    .builder\n    .appName(\"Spark Webdata\")\n    .getOrCreate()\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n25/03/10 17:15:19 WARN Utils: Your hostname, boucheron-Precision-5480 resolves to a loopback address: 127.0.1.1; using 172.23.32.10 instead (on interface enxac91a1bd3e89)\n25/03/10 17:15:19 WARN Utils: Set SPARK_LOCAL_IP if you need to bind to another address\nSetting default log level to \"WARN\".\nTo adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).\n25/03/10 17:15:19 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable\n25/03/10 17:15:19 WARN Utils: Service 'SparkUI' could not bind on port 4040. Attempting port 4041.\n```\n:::\n:::\n\n\n::: {#2eca273e .cell execution_count=3}\n``` {.python .cell-code}\nimport requests, zipfile, io\nfrom pathlib import Path\n\npath = Path('webdata.parquet')\nif not path.exists():\n    url = \"https://stephanegaiffas.github.io/big_data_course/data/webdata.parquet.zip\"\n    r = requests.get(url)\n    z = zipfile.ZipFile(io.BytesIO(r.content))\n    z.extractall(path='./')\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">BadZipFile</span>                                Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[3], line 8</span>\n<span class=\"ansi-green-fg ansi-bold\">      6</span> url <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">https://stephanegaiffas.github.io/big_data_course/data/webdata.parquet.zip</span><span style=\"color:rgb(175,0,0)\">\"</span>\n<span class=\"ansi-green-fg ansi-bold\">      7</span> r <span style=\"color:rgb(98,98,98)\">=</span> requests<span style=\"color:rgb(98,98,98)\">.</span>get(url)\n<span class=\"ansi-green-fg\">----&gt; 8</span> z <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">zipfile</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">ZipFile</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">io</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">BytesIO</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">r</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">content</span><span class=\"ansi-yellow-bg\">)</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">      9</span> z<span style=\"color:rgb(98,98,98)\">.</span>extractall(path<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">./</span><span style=\"color:rgb(175,0,0)\">'</span>)\n\nFile <span class=\"ansi-green-fg\">/usr/lib/python3.12/zipfile/__init__.py:1349</span>, in <span class=\"ansi-cyan-fg\">ZipFile.__init__</span><span class=\"ansi-blue-fg\">(self, file, mode, compression, allowZip64, compresslevel, strict_timestamps, metadata_encoding)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1347</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">try</span>:\n<span class=\"ansi-green-fg ansi-bold\">   1348</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> mode <span style=\"color:rgb(98,98,98)\">==</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">r</span><span style=\"color:rgb(175,0,0)\">'</span>:\n<span class=\"ansi-green-fg\">-&gt; 1349</span>         <span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_RealGetContents</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1350</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">elif</span> mode <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> (<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">w</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">x</span><span style=\"color:rgb(175,0,0)\">'</span>):\n<span class=\"ansi-green-fg ansi-bold\">   1351</span>         <span style=\"font-style:italic;color:rgb(95,135,135)\"># set the modified flag so central directory gets written</span>\n<span class=\"ansi-green-fg ansi-bold\">   1352</span>         <span style=\"font-style:italic;color:rgb(95,135,135)\"># even if no files are added to the archive</span>\n<span class=\"ansi-green-fg ansi-bold\">   1353</span>         <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_didModify <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">True</span>\n\nFile <span class=\"ansi-green-fg\">/usr/lib/python3.12/zipfile/__init__.py:1416</span>, in <span class=\"ansi-cyan-fg\">ZipFile._RealGetContents</span><span class=\"ansi-blue-fg\">(self)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1414</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span> BadZipFile(<span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">File is not a zip file</span><span style=\"color:rgb(175,0,0)\">\"</span>)\n<span class=\"ansi-green-fg ansi-bold\">   1415</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"font-weight:bold;color:rgb(175,0,255)\">not</span> endrec:\n<span class=\"ansi-green-fg\">-&gt; 1416</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span> BadZipFile(<span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">File is not a zip file</span><span style=\"color:rgb(175,0,0)\">\"</span>)\n<span class=\"ansi-green-fg ansi-bold\">   1417</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>debug <span style=\"color:rgb(98,98,98)\">&gt;</span> <span style=\"color:rgb(98,98,98)\">1</span>:\n<span class=\"ansi-green-fg ansi-bold\">   1418</span>     <span style=\"color:rgb(0,135,0)\">print</span>(endrec)\n\n<span class=\"ansi-red-fg\">BadZipFile</span>: File is not a zip file</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#bc19a2e7 .cell execution_count=4}\n``` {.python .cell-code}\ninput_path = './'\n\ninput_file = os.path.join(input_path, 'webdata.parquet')\n\ndf = spark.read.parquet(input_file)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">AnalysisException</span>                         Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[4], line 5</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> input_path <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">./</span><span style=\"color:rgb(175,0,0)\">'</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> input_file <span style=\"color:rgb(98,98,98)\">=</span> os<span style=\"color:rgb(98,98,98)\">.</span>path<span style=\"color:rgb(98,98,98)\">.</span>join(input_path, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">webdata.parquet</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg\">----&gt; 5</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">spark</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">read</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">parquet</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">input_file</span><span class=\"ansi-yellow-bg\">)</span>\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyspark/sql/readwriter.py:544</span>, in <span class=\"ansi-cyan-fg\">DataFrameReader.parquet</span><span class=\"ansi-blue-fg\">(self, *paths, **options)</span>\n<span class=\"ansi-green-fg ansi-bold\">    533</span> int96RebaseMode <span style=\"color:rgb(98,98,98)\">=</span> options<span style=\"color:rgb(98,98,98)\">.</span>get(<span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">int96RebaseMode</span><span style=\"color:rgb(175,0,0)\">\"</span>, <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>)\n<span class=\"ansi-green-fg ansi-bold\">    534</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_set_opts(\n<span class=\"ansi-green-fg ansi-bold\">    535</span>     mergeSchema<span style=\"color:rgb(98,98,98)\">=</span>mergeSchema,\n<span class=\"ansi-green-fg ansi-bold\">    536</span>     pathGlobFilter<span style=\"color:rgb(98,98,98)\">=</span>pathGlobFilter,\n<span class=\"ansi-green-fg\">   (...)</span>\n<span class=\"ansi-green-fg ansi-bold\">    541</span>     int96RebaseMode<span style=\"color:rgb(98,98,98)\">=</span>int96RebaseMode,\n<span class=\"ansi-green-fg ansi-bold\">    542</span> )\n<span class=\"ansi-green-fg\">--&gt; 544</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_df(<span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_jreader</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">parquet</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">_to_seq</span><span class=\"ansi-yellow-bg\">(</span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_spark</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_sc</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span class=\"ansi-yellow-bg\">paths</span><span class=\"ansi-yellow-bg\">)</span><span class=\"ansi-yellow-bg\">)</span>)\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/py4j/java_gateway.py:1322</span>, in <span class=\"ansi-cyan-fg\">JavaMember.__call__</span><span class=\"ansi-blue-fg\">(self, *args)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1316</span> command <span style=\"color:rgb(98,98,98)\">=</span> proto<span style=\"color:rgb(98,98,98)\">.</span>CALL_COMMAND_NAME <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1317</span>     <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>command_header <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1318</span>     args_command <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1319</span>     proto<span style=\"color:rgb(98,98,98)\">.</span>END_COMMAND_PART\n<span class=\"ansi-green-fg ansi-bold\">   1321</span> answer <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>gateway_client<span style=\"color:rgb(98,98,98)\">.</span>send_command(command)\n<span class=\"ansi-green-fg\">-&gt; 1322</span> return_value <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">get_return_value</span><span class=\"ansi-yellow-bg\">(</span>\n<span class=\"ansi-green-fg ansi-bold\">   1323</span> <span class=\"ansi-yellow-bg\">    </span><span class=\"ansi-yellow-bg\">answer</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">gateway_client</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">target_id</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">name</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1325</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> temp_arg <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> temp_args:\n<span class=\"ansi-green-fg ansi-bold\">   1326</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">hasattr</span>(temp_arg, <span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">_detach</span><span style=\"color:rgb(175,0,0)\">\"</span>):\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyspark/errors/exceptions/captured.py:185</span>, in <span class=\"ansi-cyan-fg\">capture_sql_exception.&lt;locals&gt;.deco</span><span class=\"ansi-blue-fg\">(*a, **kw)</span>\n<span class=\"ansi-green-fg ansi-bold\">    181</span> converted <span style=\"color:rgb(98,98,98)\">=</span> convert_exception(e<span style=\"color:rgb(98,98,98)\">.</span>java_exception)\n<span class=\"ansi-green-fg ansi-bold\">    182</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"font-weight:bold;color:rgb(175,0,255)\">not</span> <span style=\"color:rgb(0,135,0)\">isinstance</span>(converted, UnknownException):\n<span class=\"ansi-green-fg ansi-bold\">    183</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># Hide where the exception came from that shows a non-Pythonic</span>\n<span class=\"ansi-green-fg ansi-bold\">    184</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># JVM exception message.</span>\n<span class=\"ansi-green-fg\">--&gt; 185</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span> converted <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>\n<span class=\"ansi-green-fg ansi-bold\">    186</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">else</span>:\n<span class=\"ansi-green-fg ansi-bold\">    187</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span>\n\n<span class=\"ansi-red-fg\">AnalysisException</span>: [PATH_NOT_FOUND] Path does not exist: file:/home/boucheron/Documents/IFEBY310/core/notebooks/webdata.parquet.</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {.callout-note}\n\nWe can also give a try to `pyarrow.parquet` module to load the Parquet file in an Arrow table.\n\n:::\n\n::: {#eda906fc .cell execution_count=5}\n``` {.python .cell-code}\nimport pyarrow as pa\nimport comet    as co\nimport pyarrow.parquet as pq\n\ndfa = pq.read_table(input_file)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">FileNotFoundError</span>                         Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[5], line 5</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">comet</span>    <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">co</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">pyarrow</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">parquet</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">pq</span>\n<span class=\"ansi-green-fg\">----&gt; 5</span> dfa <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">pq</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">read_table</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">input_file</span><span class=\"ansi-yellow-bg\">)</span>\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyarrow/parquet/core.py:1793</span>, in <span class=\"ansi-cyan-fg\">read_table</span><span class=\"ansi-blue-fg\">(source, columns, use_threads, schema, use_pandas_metadata, read_dictionary, memory_map, buffer_size, partitioning, filesystem, filters, use_legacy_dataset, ignore_prefixes, pre_buffer, coerce_int96_timestamp_unit, decryption_properties, thrift_string_size_limit, thrift_container_size_limit, page_checksum_verification)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1787</span>     warnings<span style=\"color:rgb(98,98,98)\">.</span>warn(\n<span class=\"ansi-green-fg ansi-bold\">   1788</span>         <span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">Passing </span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">use_legacy_dataset</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\"> is deprecated as of pyarrow 15.0.0 </span><span style=\"color:rgb(175,0,0)\">\"</span>\n<span class=\"ansi-green-fg ansi-bold\">   1789</span>         <span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">and will be removed in a future version.</span><span style=\"color:rgb(175,0,0)\">\"</span>,\n<span class=\"ansi-green-fg ansi-bold\">   1790</span>         <span style=\"font-weight:bold;color:rgb(215,95,95)\">FutureWarning</span>, stacklevel<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>)\n<span class=\"ansi-green-fg ansi-bold\">   1792</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">try</span>:\n<span class=\"ansi-green-fg\">-&gt; 1793</span>     dataset <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">ParquetDataset</span><span class=\"ansi-yellow-bg\">(</span>\n<span class=\"ansi-green-fg ansi-bold\">   1794</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">source</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1795</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">schema</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">schema</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1796</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">filesystem</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">filesystem</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1797</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">partitioning</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">partitioning</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1798</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">memory_map</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">memory_map</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1799</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">read_dictionary</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">read_dictionary</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1800</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">buffer_size</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">buffer_size</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1801</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">filters</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">filters</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1802</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">ignore_prefixes</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">ignore_prefixes</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1803</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">pre_buffer</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">pre_buffer</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1804</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">coerce_int96_timestamp_unit</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">coerce_int96_timestamp_unit</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1805</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">decryption_properties</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">decryption_properties</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1806</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">thrift_string_size_limit</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">thrift_string_size_limit</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1807</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">thrift_container_size_limit</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">thrift_container_size_limit</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1808</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">page_checksum_verification</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">page_checksum_verification</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1809</span> <span class=\"ansi-yellow-bg\">    </span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1810</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">except</span> <span style=\"font-weight:bold;color:rgb(215,95,95)\">ImportError</span>:\n<span class=\"ansi-green-fg ansi-bold\">   1811</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># fall back on ParquetFile for simple cases when pyarrow.dataset</span>\n<span class=\"ansi-green-fg ansi-bold\">   1812</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># module is not available</span>\n<span class=\"ansi-green-fg ansi-bold\">   1813</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> filters <span style=\"font-weight:bold;color:rgb(175,0,255)\">is</span> <span style=\"font-weight:bold;color:rgb(175,0,255)\">not</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>:\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyarrow/parquet/core.py:1371</span>, in <span class=\"ansi-cyan-fg\">ParquetDataset.__init__</span><span class=\"ansi-blue-fg\">(self, path_or_paths, filesystem, schema, filters, read_dictionary, memory_map, buffer_size, partitioning, ignore_prefixes, pre_buffer, coerce_int96_timestamp_unit, decryption_properties, thrift_string_size_limit, thrift_container_size_limit, page_checksum_verification, use_legacy_dataset)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1367</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> partitioning <span style=\"color:rgb(98,98,98)\">==</span> <span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">hive</span><span style=\"color:rgb(175,0,0)\">\"</span>:\n<span class=\"ansi-green-fg ansi-bold\">   1368</span>     partitioning <span style=\"color:rgb(98,98,98)\">=</span> ds<span style=\"color:rgb(98,98,98)\">.</span>HivePartitioning<span style=\"color:rgb(98,98,98)\">.</span>discover(\n<span class=\"ansi-green-fg ansi-bold\">   1369</span>         infer_dictionary<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">True</span>)\n<span class=\"ansi-green-fg\">-&gt; 1371</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_dataset <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">ds</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">dataset</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">path_or_paths</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span class=\"ansi-yellow-bg\">filesystem</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">filesystem</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1372</span> <span class=\"ansi-yellow-bg\">                           </span><span class=\"ansi-yellow-bg\">schema</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">schema</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">format</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">parquet_format</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1373</span> <span class=\"ansi-yellow-bg\">                           </span><span class=\"ansi-yellow-bg\">partitioning</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">partitioning</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1374</span> <span class=\"ansi-yellow-bg\">                           </span><span class=\"ansi-yellow-bg\">ignore_prefixes</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">ignore_prefixes</span><span class=\"ansi-yellow-bg\">)</span>\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyarrow/dataset.py:794</span>, in <span class=\"ansi-cyan-fg\">dataset</span><span class=\"ansi-blue-fg\">(source, schema, format, filesystem, partitioning, partition_base_dir, exclude_invalid_files, ignore_prefixes)</span>\n<span class=\"ansi-green-fg ansi-bold\">    783</span> kwargs <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">dict</span>(\n<span class=\"ansi-green-fg ansi-bold\">    784</span>     schema<span style=\"color:rgb(98,98,98)\">=</span>schema,\n<span class=\"ansi-green-fg ansi-bold\">    785</span>     filesystem<span style=\"color:rgb(98,98,98)\">=</span>filesystem,\n<span class=\"ansi-green-fg\">   (...)</span>\n<span class=\"ansi-green-fg ansi-bold\">    790</span>     selector_ignore_prefixes<span style=\"color:rgb(98,98,98)\">=</span>ignore_prefixes\n<span class=\"ansi-green-fg ansi-bold\">    791</span> )\n<span class=\"ansi-green-fg ansi-bold\">    793</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> _is_path_like(source):\n<span class=\"ansi-green-fg\">--&gt; 794</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> <span class=\"ansi-yellow-bg\">_filesystem_dataset</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">source</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">*</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-yellow-bg\">kwargs</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">    795</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">elif</span> <span style=\"color:rgb(0,135,0)\">isinstance</span>(source, (<span style=\"color:rgb(0,135,0)\">tuple</span>, <span style=\"color:rgb(0,135,0)\">list</span>)):\n<span class=\"ansi-green-fg ansi-bold\">    796</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">all</span>(_is_path_like(elem) <span style=\"font-weight:bold;color:rgb(175,0,255)\">or</span> <span style=\"color:rgb(0,135,0)\">isinstance</span>(elem, FileInfo) <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> elem <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> source):\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyarrow/dataset.py:476</span>, in <span class=\"ansi-cyan-fg\">_filesystem_dataset</span><span class=\"ansi-blue-fg\">(source, schema, filesystem, partitioning, format, partition_base_dir, exclude_invalid_files, selector_ignore_prefixes)</span>\n<span class=\"ansi-green-fg ansi-bold\">    474</span>         fs, paths_or_selector <span style=\"color:rgb(98,98,98)\">=</span> _ensure_multiple_sources(source, filesystem)\n<span class=\"ansi-green-fg ansi-bold\">    475</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">else</span>:\n<span class=\"ansi-green-fg\">--&gt; 476</span>     fs, paths_or_selector <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">_ensure_single_source</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">source</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span class=\"ansi-yellow-bg\">filesystem</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">    478</span> options <span style=\"color:rgb(98,98,98)\">=</span> FileSystemFactoryOptions(\n<span class=\"ansi-green-fg ansi-bold\">    479</span>     partitioning<span style=\"color:rgb(98,98,98)\">=</span>partitioning,\n<span class=\"ansi-green-fg ansi-bold\">    480</span>     partition_base_dir<span style=\"color:rgb(98,98,98)\">=</span>partition_base_dir,\n<span class=\"ansi-green-fg ansi-bold\">    481</span>     exclude_invalid_files<span style=\"color:rgb(98,98,98)\">=</span>exclude_invalid_files,\n<span class=\"ansi-green-fg ansi-bold\">    482</span>     selector_ignore_prefixes<span style=\"color:rgb(98,98,98)\">=</span>selector_ignore_prefixes\n<span class=\"ansi-green-fg ansi-bold\">    483</span> )\n<span class=\"ansi-green-fg ansi-bold\">    484</span> factory <span style=\"color:rgb(98,98,98)\">=</span> FileSystemDatasetFactory(fs, paths_or_selector, <span style=\"color:rgb(0,135,0)\">format</span>, options)\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyarrow/dataset.py:441</span>, in <span class=\"ansi-cyan-fg\">_ensure_single_source</span><span class=\"ansi-blue-fg\">(path, filesystem)</span>\n<span class=\"ansi-green-fg ansi-bold\">    439</span>     paths_or_selector <span style=\"color:rgb(98,98,98)\">=</span> [path]\n<span class=\"ansi-green-fg ansi-bold\">    440</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">else</span>:\n<span class=\"ansi-green-fg\">--&gt; 441</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span> <span style=\"font-weight:bold;color:rgb(215,95,95)\">FileNotFoundError</span>(path)\n<span class=\"ansi-green-fg ansi-bold\">    443</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> filesystem, paths_or_selector\n\n<span class=\"ansi-red-fg\">FileNotFoundError</span>: ./webdata.parquet</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#df19373e .cell execution_count=6}\n``` {.python .cell-code}\ndfa.num_columns\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[6], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">dfa</span><span style=\"color:rgb(98,98,98)\">.</span>num_columns\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'dfa' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {.callout-warning}\n\nLet us go back to the spark data frame\n\n:::\n\n::: {#d7aa3dbd .cell execution_count=7}\n``` {.python .cell-code}\ndf.printSchema()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[7], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>printSchema()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#ba4364fc .cell execution_count=8}\n``` {.python .cell-code}\ndf.rdd.getNumPartitions()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[8], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>rdd<span style=\"color:rgb(98,98,98)\">.</span>getNumPartitions()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {.callout-note  title=\"Question\"}\n\nExplain the partition size. \n\n:::\n\n::: {#3e1371ce .cell execution_count=9}\n``` {.python .cell-code}\ndf.rdd.toDebugString()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[9], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>rdd<span style=\"color:rgb(98,98,98)\">.</span>toDebugString()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n# Basic statistics\n\nFirst we need to import some things:\n\n- `Window` class\n- SQL functions module\n- Some very useful functions\n- Spark types\n\n::: {#d9a5a53b .cell execution_count=10}\n``` {.python .cell-code}\nfrom pyspark.sql import Window\nimport pyspark.sql.functions as func\nfrom pyspark.sql.types import *\nfrom pyspark.sql.functions import col, lit\n```\n:::\n\n\n## Compute the total number of unique users\n\n::: {#b83f9a64 .cell execution_count=11}\n``` {.python .cell-code}\n( \n    df.select('xid')\n      .distinct()\n      .count()\n)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[11], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> ( \n<span class=\"ansi-green-fg\">----&gt; 2</span>     <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>select(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">xid</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      3</span>       <span style=\"color:rgb(98,98,98)\">.</span>distinct()\n<span class=\"ansi-green-fg ansi-bold\">      4</span>       <span style=\"color:rgb(98,98,98)\">.</span>count()\n<span class=\"ansi-green-fg ansi-bold\">      5</span> )\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#bf9ec848 .cell execution_count=12}\n``` {.python .cell-code}\ndef foo(x): yield len(set(x))\n```\n:::\n\n\n::: {#13163650 .cell execution_count=13}\n``` {.python .cell-code}\n( df.rdd\n    .map(lambda x : x.xid)\n    .mapPartitions(foo)\n    .collect()\n)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[13], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> ( <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>rdd\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     <span style=\"color:rgb(98,98,98)\">.</span>map(<span style=\"font-weight:bold;color:rgb(0,135,0)\">lambda</span> x : x<span style=\"color:rgb(98,98,98)\">.</span>xid)\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     <span style=\"color:rgb(98,98,98)\">.</span>mapPartitions(foo)\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     <span style=\"color:rgb(98,98,98)\">.</span>collect()\n<span class=\"ansi-green-fg ansi-bold\">      5</span> )\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\nThis might pump up some computational resources \n\n::: {#f1d2b710 .cell execution_count=14}\n``` {.python .cell-code}\n( \n    df.select('xid')\n      .distinct() \n      .explain()\n)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[14], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> ( \n<span class=\"ansi-green-fg\">----&gt; 2</span>     <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>select(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">xid</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      3</span>       <span style=\"color:rgb(98,98,98)\">.</span>distinct() \n<span class=\"ansi-green-fg ansi-bold\">      4</span>       <span style=\"color:rgb(98,98,98)\">.</span>explain()\n<span class=\"ansi-green-fg ansi-bold\">      5</span> )\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {.callout-note}\n\nThe distinct values of `xid` seem to be evenly spread among the six files making the `parquet` directory. Note that the last six partitions look empty. \n\n:::\n\n## Construct a column containing the total number of actions per user\n\n::: {#5cb46526 .cell execution_count=15}\n``` {.python .cell-code}\nxid_partition = Window.partitionBy('xid')\n\nn_events = func.count(col('action')).over(xid_partition)\n\ndf = df.withColumn('n_events', n_events)\n\ndf.head(n=2)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[15], line 5</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> xid_partition <span style=\"color:rgb(98,98,98)\">=</span> Window<span style=\"color:rgb(98,98,98)\">.</span>partitionBy(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">xid</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      3</span> n_events <span style=\"color:rgb(98,98,98)\">=</span> func<span style=\"color:rgb(98,98,98)\">.</span>count(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">action</span><span style=\"color:rgb(175,0,0)\">'</span>))<span style=\"color:rgb(98,98,98)\">.</span>over(xid_partition)\n<span class=\"ansi-green-fg\">----&gt; 5</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_events</span><span style=\"color:rgb(175,0,0)\">'</span>, n_events)\n<span class=\"ansi-green-fg ansi-bold\">      7</span> df<span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#e46739ec .cell execution_count=16}\n``` {.python .cell-code}\n( \n  df\n    .groupBy('xid')\n    .agg(func.count('action'))\n    .head(5)\n)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[16], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> ( \n<span class=\"ansi-green-fg\">----&gt; 2</span>   <span class=\"ansi-yellow-bg\">df</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     <span style=\"color:rgb(98,98,98)\">.</span>groupBy(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">xid</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     <span style=\"color:rgb(98,98,98)\">.</span>agg(func<span style=\"color:rgb(98,98,98)\">.</span>count(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">action</span><span style=\"color:rgb(175,0,0)\">'</span>))\n<span class=\"ansi-green-fg ansi-bold\">      5</span>     <span style=\"color:rgb(98,98,98)\">.</span>head(<span style=\"color:rgb(98,98,98)\">5</span>)\n<span class=\"ansi-green-fg ansi-bold\">      6</span> )\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n## Construct a column containing the number of days since the last action of the user\n\n::: {#57ba0ab3 .cell execution_count=17}\n``` {.python .cell-code}\nmax_date = (\n  func\n    .max(col('date'))\n    .over(xid_partition)\n)\n\nn_days_since_last_event = func.datediff(func.current_date(), max_date)\n\ndf = df.withColumn('n_days_since_last_event',\n                   n_days_since_last_event)\n\ndf.head(n=2)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[17], line 9</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> max_date <span style=\"color:rgb(98,98,98)\">=</span> (\n<span class=\"ansi-green-fg ansi-bold\">      2</span>   func\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     <span style=\"color:rgb(98,98,98)\">.</span>max(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">date</span><span style=\"color:rgb(175,0,0)\">'</span>))\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     <span style=\"color:rgb(98,98,98)\">.</span>over(xid_partition)\n<span class=\"ansi-green-fg ansi-bold\">      5</span> )\n<span class=\"ansi-green-fg ansi-bold\">      7</span> n_days_since_last_event <span style=\"color:rgb(98,98,98)\">=</span> func<span style=\"color:rgb(98,98,98)\">.</span>datediff(func<span style=\"color:rgb(98,98,98)\">.</span>current_date(), max_date)\n<span class=\"ansi-green-fg\">----&gt; 9</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_days_since_last_event</span><span style=\"color:rgb(175,0,0)\">'</span>,\n<span class=\"ansi-green-fg ansi-bold\">     10</span>                    n_days_since_last_event)\n<span class=\"ansi-green-fg ansi-bold\">     12</span> df<span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#218d70ae .cell execution_count=18}\n``` {.python .cell-code}\ndf.printSchema()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[18], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>printSchema()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n## Construct a column containing the number of actions of each user for each modality of device\n\nDoes this `partitionBy` triggers shuffling? \n\n::: {#9594cc49 .cell execution_count=19}\n``` {.python .cell-code}\nxid_device_partition = xid_partition.partitionBy('device')\n\nn_events_per_device = func.count(col('action')).over(xid_device_partition)\n\ndf = df.withColumn('n_events_per_device', n_events_per_device)\n\ndf.head(n=2)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[19], line 5</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> xid_device_partition <span style=\"color:rgb(98,98,98)\">=</span> xid_partition<span style=\"color:rgb(98,98,98)\">.</span>partitionBy(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">device</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      3</span> n_events_per_device <span style=\"color:rgb(98,98,98)\">=</span> func<span style=\"color:rgb(98,98,98)\">.</span>count(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">action</span><span style=\"color:rgb(175,0,0)\">'</span>))<span style=\"color:rgb(98,98,98)\">.</span>over(xid_device_partition)\n<span class=\"ansi-green-fg\">----&gt; 5</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_events_per_device</span><span style=\"color:rgb(175,0,0)\">'</span>, n_events_per_device)\n<span class=\"ansi-green-fg ansi-bold\">      7</span> df<span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n## Number of devices per user {{< fa mug-hot >}}\n\n::: {#62389875 .cell execution_count=20}\n``` {.python .cell-code}\n# xid_partition = Window.partitionBy('xid')\n\nrank_device = (\n  func\n    .dense_rank()\n    .over(xid_partition.orderBy('device'))\n)\n\nn_unique_device = (\n    func\n      .last(rank_device)\n      .over(xid_partition)\n)\n\ndf = df.withColumn('n_device', n_unique_device)\n\ndf.head(n=2)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[20], line 15</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> rank_device <span style=\"color:rgb(98,98,98)\">=</span> (\n<span class=\"ansi-green-fg ansi-bold\">      4</span>   func\n<span class=\"ansi-green-fg ansi-bold\">      5</span>     <span style=\"color:rgb(98,98,98)\">.</span>dense_rank()\n<span class=\"ansi-green-fg ansi-bold\">      6</span>     <span style=\"color:rgb(98,98,98)\">.</span>over(xid_partition<span style=\"color:rgb(98,98,98)\">.</span>orderBy(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">device</span><span style=\"color:rgb(175,0,0)\">'</span>))\n<span class=\"ansi-green-fg ansi-bold\">      7</span> )\n<span class=\"ansi-green-fg ansi-bold\">      9</span> n_unique_device <span style=\"color:rgb(98,98,98)\">=</span> (\n<span class=\"ansi-green-fg ansi-bold\">     10</span>     func\n<span class=\"ansi-green-fg ansi-bold\">     11</span>       <span style=\"color:rgb(98,98,98)\">.</span>last(rank_device)\n<span class=\"ansi-green-fg ansi-bold\">     12</span>       <span style=\"color:rgb(98,98,98)\">.</span>over(xid_partition)\n<span class=\"ansi-green-fg ansi-bold\">     13</span> )\n<span class=\"ansi-green-fg\">---&gt; 15</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_device</span><span style=\"color:rgb(175,0,0)\">'</span>, n_unique_device)\n<span class=\"ansi-green-fg ansi-bold\">     17</span> df<span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#3e183af3 .cell execution_count=21}\n``` {.python .cell-code}\ndf\\\n    .where(col('n_device') > 1)\\\n    .select('xid', 'device', 'n_events',  'n_device', 'n_events_per_device')\\\n    .head(n=8)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[21], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span>\\\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     <span style=\"color:rgb(98,98,98)\">.</span>where(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_device</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">&gt;</span> <span style=\"color:rgb(98,98,98)\">1</span>)\\\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     <span style=\"color:rgb(98,98,98)\">.</span>select(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">xid</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">device</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_events</span><span style=\"color:rgb(175,0,0)\">'</span>,  <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_device</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_events_per_device</span><span style=\"color:rgb(175,0,0)\">'</span>)\\\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     <span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">8</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#064ce8fc .cell execution_count=22}\n``` {.python .cell-code}\ndf\\\n    .where(col('n_device') > 1)\\\n    .select('xid', 'device', 'n_events',  'n_device', 'n_events_per_device')\\\n    .count()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[22], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span>\\\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     <span style=\"color:rgb(98,98,98)\">.</span>where(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_device</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">&gt;</span> <span style=\"color:rgb(98,98,98)\">1</span>)\\\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     <span style=\"color:rgb(98,98,98)\">.</span>select(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">xid</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">device</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_events</span><span style=\"color:rgb(175,0,0)\">'</span>,  <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_device</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_events_per_device</span><span style=\"color:rgb(175,0,0)\">'</span>)\\\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     <span style=\"color:rgb(98,98,98)\">.</span>count()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n# Let's select the correct users and build a training dataset\n\nWe construct a ETL (Extract Transform Load) process on this data using the `pyspark.sql` API.\n\n## Extraction\n\nHere extraction is just about reading the data\n\n::: {#3daa0ec9 .cell execution_count=23}\n``` {.python .cell-code}\ndf = spark.read.parquet(input_file)\ndf.head(n=3)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">AnalysisException</span>                         Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[23], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">spark</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">read</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">parquet</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">input_file</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> df<span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">3</span>)\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyspark/sql/readwriter.py:544</span>, in <span class=\"ansi-cyan-fg\">DataFrameReader.parquet</span><span class=\"ansi-blue-fg\">(self, *paths, **options)</span>\n<span class=\"ansi-green-fg ansi-bold\">    533</span> int96RebaseMode <span style=\"color:rgb(98,98,98)\">=</span> options<span style=\"color:rgb(98,98,98)\">.</span>get(<span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">int96RebaseMode</span><span style=\"color:rgb(175,0,0)\">\"</span>, <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>)\n<span class=\"ansi-green-fg ansi-bold\">    534</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_set_opts(\n<span class=\"ansi-green-fg ansi-bold\">    535</span>     mergeSchema<span style=\"color:rgb(98,98,98)\">=</span>mergeSchema,\n<span class=\"ansi-green-fg ansi-bold\">    536</span>     pathGlobFilter<span style=\"color:rgb(98,98,98)\">=</span>pathGlobFilter,\n<span class=\"ansi-green-fg\">   (...)</span>\n<span class=\"ansi-green-fg ansi-bold\">    541</span>     int96RebaseMode<span style=\"color:rgb(98,98,98)\">=</span>int96RebaseMode,\n<span class=\"ansi-green-fg ansi-bold\">    542</span> )\n<span class=\"ansi-green-fg\">--&gt; 544</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_df(<span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_jreader</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">parquet</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">_to_seq</span><span class=\"ansi-yellow-bg\">(</span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_spark</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_sc</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span class=\"ansi-yellow-bg\">paths</span><span class=\"ansi-yellow-bg\">)</span><span class=\"ansi-yellow-bg\">)</span>)\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/py4j/java_gateway.py:1322</span>, in <span class=\"ansi-cyan-fg\">JavaMember.__call__</span><span class=\"ansi-blue-fg\">(self, *args)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1316</span> command <span style=\"color:rgb(98,98,98)\">=</span> proto<span style=\"color:rgb(98,98,98)\">.</span>CALL_COMMAND_NAME <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1317</span>     <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>command_header <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1318</span>     args_command <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1319</span>     proto<span style=\"color:rgb(98,98,98)\">.</span>END_COMMAND_PART\n<span class=\"ansi-green-fg ansi-bold\">   1321</span> answer <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>gateway_client<span style=\"color:rgb(98,98,98)\">.</span>send_command(command)\n<span class=\"ansi-green-fg\">-&gt; 1322</span> return_value <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">get_return_value</span><span class=\"ansi-yellow-bg\">(</span>\n<span class=\"ansi-green-fg ansi-bold\">   1323</span> <span class=\"ansi-yellow-bg\">    </span><span class=\"ansi-yellow-bg\">answer</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">gateway_client</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">target_id</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">name</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1325</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> temp_arg <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> temp_args:\n<span class=\"ansi-green-fg ansi-bold\">   1326</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">hasattr</span>(temp_arg, <span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">_detach</span><span style=\"color:rgb(175,0,0)\">\"</span>):\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyspark/errors/exceptions/captured.py:185</span>, in <span class=\"ansi-cyan-fg\">capture_sql_exception.&lt;locals&gt;.deco</span><span class=\"ansi-blue-fg\">(*a, **kw)</span>\n<span class=\"ansi-green-fg ansi-bold\">    181</span> converted <span style=\"color:rgb(98,98,98)\">=</span> convert_exception(e<span style=\"color:rgb(98,98,98)\">.</span>java_exception)\n<span class=\"ansi-green-fg ansi-bold\">    182</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"font-weight:bold;color:rgb(175,0,255)\">not</span> <span style=\"color:rgb(0,135,0)\">isinstance</span>(converted, UnknownException):\n<span class=\"ansi-green-fg ansi-bold\">    183</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># Hide where the exception came from that shows a non-Pythonic</span>\n<span class=\"ansi-green-fg ansi-bold\">    184</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># JVM exception message.</span>\n<span class=\"ansi-green-fg\">--&gt; 185</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span> converted <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>\n<span class=\"ansi-green-fg ansi-bold\">    186</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">else</span>:\n<span class=\"ansi-green-fg ansi-bold\">    187</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span>\n\n<span class=\"ansi-red-fg\">AnalysisException</span>: [PATH_NOT_FOUND] Path does not exist: file:/home/boucheron/Documents/IFEBY310/core/notebooks/webdata.parquet.</pre>\n```\n:::\n\n:::\n:::\n\n\n## Transformation of the data\n\nAt this step we compute a lot of extra things from the data. The aim is to build *features* that describe users.\n\n::: {#76e53b15 .cell execution_count=24}\n``` {.python .cell-code}\ndef n_events_transformer(df):\n    xid_partition = Window.partitionBy('xid')\n    n_events = func.count(col('action')).over(xid_partition)\n    \n    df = df.withColumn('n_events', n_events)\n\n    return df\n```\n:::\n\n\n::: {#9d437abe .cell execution_count=25}\n``` {.python .cell-code}\ndef n_events_per_action_transformer(df):\n    xid_action_partition = Window.partitionBy('xid', 'action')\n    n_events_per_action = func.count(col('action')).over(xid_action_partition)\n\n    df = df.withColumn('n_events_per_action', n_events_per_action)\n    \n    return df\n```\n:::\n\n\n::: {#97f139cf .cell execution_count=26}\n``` {.python .cell-code}\ndef hour_transformer(df):\n    hour = func.hour(col('date'))\n    df = df.withColumn('hour', hour)\n    return df\n\ndef weekday_transformer(df):\n    weekday = func.date_format(col('date'), 'EEEE')\n    df = df.withColumn('weekday', weekday)\n    return df\n\ndef n_events_per_hour_transformer(df):\n    xid_hour_partition = Window.partitionBy('xid', 'hour')\n    n_events_per_hour = func.count(col('action')).over(xid_hour_partition)\n    df = df.withColumn('n_events_per_hour', n_events_per_hour)\n    return df\n\ndef n_events_per_weekday_transformer(df):\n    xid_weekday_partition = Window.partitionBy('xid', 'weekday')\n    n_events_per_weekday = func.count(col('action')).over(xid_weekday_partition)\n    df = df.withColumn('n_events_per_weekday', n_events_per_weekday)\n    return df\n\ndef n_days_since_last_event_transformer(df):\n    xid_partition = Window.partitionBy('xid')\n    max_date = func.max(col('date')).over(xid_partition)\n    n_days_since_last_event = func.datediff(func.current_date(), max_date)\n    df = df.withColumn('n_days_since_last_event',\n                       n_days_since_last_event + lit(0.1))\n    return df\n\ndef n_days_since_last_action_transformer(df):\n    xid_partition_action = Window.partitionBy('xid', 'action')\n    max_date = func.max(col('date')).over(xid_partition_action)\n    n_days_since_last_action = func.datediff(func.current_date(),\n                                                        max_date)\n    df = df.withColumn('n_days_since_last_action',\n                       n_days_since_last_action + lit(0.1))\n    return df\n\ndef n_unique_day_transformer(df):\n    xid_partition = Window.partitionBy('xid')\n    dayofyear = func.dayofyear(col('date'))\n    rank_day = func.dense_rank().over(xid_partition.orderBy(dayofyear))\n    n_unique_day = func.last(rank_day).over(xid_partition)\n    df = df.withColumn('n_unique_day', n_unique_day)\n    return df\n\ndef n_unique_hour_transformer(df):\n    xid_partition = Window.partitionBy('xid')\n    rank_hour = func.dense_rank().over(xid_partition.orderBy('hour'))\n    n_unique_hour = func.last(rank_hour).over(xid_partition)\n    df = df.withColumn('n_unique_hour', n_unique_hour)\n    return df\n\ndef n_events_per_device_transformer(df):\n    xid_device_partition = Window.partitionBy('xid', 'device')\n    n_events_per_device = func.count(func.col('device')) \\\n        .over(xid_device_partition)\n    df = df.withColumn('n_events_per_device', n_events_per_device)\n    return df\n\ndef n_unique_device_transformer(df):\n    xid_partition = Window.partitionBy('xid')\n    rank_device = func.dense_rank().over(xid_partition.orderBy('device'))\n    n_unique_device = func.last(rank_device).over(xid_partition)\n    df = df.withColumn('n_device', n_unique_device)\n    return df\n\ndef n_actions_per_category_id_transformer(df):\n    xid_category_id_partition = Window.partitionBy('xid', 'category_id',\n                                                   'action')\n    n_actions_per_category_id = func.count(func.col('action')) \\\n        .over(xid_category_id_partition)\n    df = df.withColumn('n_actions_per_category_id', n_actions_per_category_id)\n    return df\n\ndef n_unique_category_id_transformer(df):\n    xid_partition = Window.partitionBy('xid')\n    rank_category_id = func.dense_rank().over(xid_partition\\\n                                              .orderBy('category_id'))\n    n_unique_category_id = func.last(rank_category_id).over(xid_partition)\n    df = df.withColumn('n_unique_category_id', n_unique_category_id)\n    return df\n\ndef n_events_per_category_id_transformer(df):\n    xid_category_id_partition = Window.partitionBy('xid', 'category_id')\n    n_events_per_category_id = func.count(func.col('action')) \\\n        .over(xid_category_id_partition)\n    df = df.withColumn('n_events_per_category_id', n_events_per_category_id)\n    return df\n\ndef n_events_per_website_id_transformer(df):\n    xid_website_id_partition = Window.partitionBy('xid', 'website_id')\n    n_events_per_website_id = func.count(col('action'))\\\n        .over(xid_website_id_partition)\n    df = df.withColumn('n_events_per_website_id', n_events_per_website_id)\n    return df\n```\n:::\n\n\n::: {#8ed17c89 .cell execution_count=27}\n``` {.python .cell-code}\ntransformers = [\n    hour_transformer,\n    weekday_transformer,\n    n_events_per_hour_transformer,\n    n_events_per_weekday_transformer,\n    n_days_since_last_event_transformer,\n    n_days_since_last_action_transformer,\n    n_unique_day_transformer,\n    n_unique_hour_transformer,\n    n_events_per_device_transformer,\n    n_unique_device_transformer,\n    n_actions_per_category_id_transformer,\n    n_events_per_category_id_transformer,\n    n_events_per_website_id_transformer,\n]\n```\n:::\n\n\n::: {#abf85845 .cell execution_count=28}\n``` {.python .cell-code}\nN = 10000\n```\n:::\n\n\n::: {#d9285d40 .cell execution_count=29}\n``` {.python .cell-code}\nsample_df = df.sample(withReplacement=False, fraction=.05)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[29], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> sample_df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>sample(withReplacement<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">False</span>, fraction<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">.05</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#bee8ad17 .cell execution_count=30}\n``` {.python .cell-code}\nsample_df.count()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[30], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">sample_df</span><span style=\"color:rgb(98,98,98)\">.</span>count()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'sample_df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#24dc41f5 .cell execution_count=31}\n``` {.python .cell-code}\nfor transformer in transformers:\n    df = transformer(df)\n\ndf.head(n=1)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[31], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> transformer <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> transformers:\n<span class=\"ansi-green-fg\">----&gt; 2</span>     df <span style=\"color:rgb(98,98,98)\">=</span> transformer(<span class=\"ansi-yellow-bg\">df</span>)\n<span class=\"ansi-green-fg ansi-bold\">      4</span> df<span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#27a4dced .cell execution_count=32}\n``` {.python .cell-code}\nfor transformer in transformers:\n    sample_df = transformer(sample_df)\n\nsample_df.head(n=1)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[32], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> transformer <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> transformers:\n<span class=\"ansi-green-fg\">----&gt; 2</span>     sample_df <span style=\"color:rgb(98,98,98)\">=</span> transformer(<span class=\"ansi-yellow-bg\">sample_df</span>)\n<span class=\"ansi-green-fg ansi-bold\">      4</span> sample_df<span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'sample_df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#ac56f02c .cell execution_count=33}\n``` {.python .cell-code}\ndf = sample_df\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[33], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">sample_df</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'sample_df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#b1fc3bc5 .cell execution_count=34}\n``` {.python .cell-code}\nsorted(df.columns)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[34], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"color:rgb(0,135,0)\">sorted</span>(<span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>columns)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#4c0b8c4b .cell execution_count=35}\n``` {.python .cell-code}\ndf.explain()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[35], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>explain()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#56385992 .cell execution_count=36}\n``` {.python .cell-code}\nspark._sc.setCheckpointDir(\".\")   \n\ndf.checkpoint()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[36], line 3</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> spark<span style=\"color:rgb(98,98,98)\">.</span>_sc<span style=\"color:rgb(98,98,98)\">.</span>setCheckpointDir(<span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">.</span><span style=\"color:rgb(175,0,0)\">\"</span>)   \n<span class=\"ansi-green-fg\">----&gt; 3</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>checkpoint()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#cdcd7925 .cell execution_count=37}\n``` {.python .cell-code}\ndf.explain()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[37], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>explain()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n## Load step\n\nHere, we use all the previous computations (saved in the columns of the dataframe) \nto compute aggregated informations about each user.\n\n\n::: {.callout-note}\n\nThis should be DRYED \n\n:::\n\n::: {#0d37a7d6 .cell execution_count=38}\n``` {.python .cell-code}\ndef n_events_per_hour_loader(df):\n    csr = df\\\n        .select('xid', 'hour', 'n_events_per_hour')\\\n        .withColumnRenamed('n_events_per_hour', 'value')\\\n        .distinct() \n            # action\n    feature_name = func.concat(lit('n_events_per_hour#'), col('hour'))\n\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('hour')\n    return csr\n\ndef n_events_per_website_id_loader(df):\n    csr = df.select('xid', 'website_id', 'n_events_per_website_id')\\\n        .withColumnRenamed('n_events_per_hour', 'value')\\\n        .distinct()\n\n    feature_name = func.concat(lit('n_events_per_website_id#'),\n                               col('website_id'))\n    \n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('website_id')\n    return csr\n\ndef n_events_per_hour_loader(df):\n    csr = df\\\n        .select('xid', 'hour', 'n_events_per_hour')\\\n        .withColumnRenamed('n_events_per_hour', 'value')\\\n        .distinct()\n\n    feature_name = func.concat(lit('n_events_per_hour#'), col('hour'))\n    \n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('hour')\n    return csr\n\ndef n_events_per_weekday_loader(df):\n    csr = df\\\n        .select('xid', 'weekday', 'n_events_per_weekday')\\\n        .withColumnRenamed('n_events_per_weekday', 'value')\\\n        .distinct()\n\n    feature_name = func.concat(lit('n_events_per_weekday#'), col('weekday'))\n    \n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('weekday')\n\n    return csr\n\ndef n_days_since_last_event_loader(df):\n    csr = df.select('xid',  'n_days_since_last_event')\\\n        .withColumnRenamed('n_days_since_last_event', 'value')\\\n        .distinct()\n    feature_name = lit('n_days_since_last_event')\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\n    return csr\n\ndef n_days_since_last_action_loader(df):\n    csr = df.select('xid', 'action', 'n_days_since_last_action')\\\n        .withColumnRenamed('n_days_since_last_action', 'value')\\\n        .distinct()\n    feature_name = func.concat(lit('n_days_since_last_action#'), col('action'))\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('action')\n    return csr\n\ndef n_unique_day_loader(df):\n    csr = df.select('xid', 'n_unique_day')\\\n        .withColumnRenamed('n_unique_day', 'value')\\\n        .distinct()\n    feature_name = lit('n_unique_day')\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\n    return csr\n\ndef n_unique_hour_loader(df):\n    csr = df.select('xid', 'n_unique_hour')\\\n        .withColumnRenamed('n_unique_hour', 'value')\\\n        .distinct()\n    feature_name = lit('n_unique_hour')\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\n    return csr\n\ndef n_events_per_device_loader(df):\n    csr = df\\\n        .select('xid', 'device', 'n_events_per_device')\\\n        .withColumnRenamed('n_events_per_device', 'value')\\\n        .distinct()\n    feature_name = func.concat(lit('n_events_per_device#'), col('device'))\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('device')\n    return csr\n\ndef n_unique_device_loader(df):\n    csr = df.select('xid', 'n_device')\\\n        .withColumnRenamed('n_device', 'value')\\\n        .distinct()\n    feature_name = lit('n_device')\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\n    return csr\n\ndef n_events_per_category_id_loader(df):\n    csr = df.select('xid', 'category_id', 'n_events_per_category_id')\\\n        .withColumnRenamed('n_events_per_category_id', 'value')\\\n        .distinct()\n    feature_name = func.concat(lit('n_events_per_category_id#'),\n                               col('category_id'))\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('category_id')\n    return csr\n\ndef n_actions_per_category_id_loader(df):\n    csr = df.select('xid', 'category_id', 'action', 'n_actions_per_category_id')\\\n        .withColumnRenamed('n_actions_per_category_id', 'value')\\\n        .distinct()\n    feature_name = func.concat(lit('n_actions_per_category_id#'),\n                               col('action'), lit('#'), \n                               col('category_id'))\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('category_id')\\\n        .drop('action')\n    return csr\n\ndef n_events_per_website_id_loader(df):\n    csr = df.select('xid', 'website_id', 'n_events_per_website_id')\\\n        .withColumnRenamed('n_events_per_website_id', 'value')\\\n        .distinct()\n    feature_name = func.concat(lit('n_events_per_website_id#'),\n                               col('website_id'))\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('website_id')\n    return csr\n```\n:::\n\n\n::: {#7426a4c2 .cell execution_count=39}\n``` {.python .cell-code}\nfrom functools import reduce\n```\n:::\n\n\n::: {#be60b53f .cell execution_count=40}\n``` {.python .cell-code}\nloaders = [\n    n_events_per_hour_loader,\n    n_events_per_website_id_loader,\n    n_events_per_hour_loader,\n    n_events_per_weekday_loader,\n    n_days_since_last_event_loader,\n    n_days_since_last_action_loader,\n    n_unique_day_loader,\n    n_unique_hour_loader,\n    n_events_per_device_loader,\n    n_unique_device_loader,\n    n_events_per_category_id_loader,\n    n_actions_per_category_id_loader,\n    n_events_per_website_id_loader,\n]\n```\n:::\n\n\n::: {#de35bc49 .cell execution_count=41}\n``` {.python .cell-code}\ndef union(df, other):\n    return df.union(other)\n```\n:::\n\n\n::: {.callout-caution title=\"About DataFrame.union()\"}\n\nThis method performs a SQL-style set union of the rows from both DataFrame objects, with no automatic deduplication of elements.\n\nUse the distinct() method to perform deduplication of rows.\n\nThe method resolves columns by position (not by name), following the standard behavior in SQL.\n\n:::\n\n::: {#d764a0ba .cell execution_count=42}\n``` {.python .cell-code}\nspam = [loader(df) for loader in loaders]\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[42], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> spam <span style=\"color:rgb(98,98,98)\">=</span> [loader(<span class=\"ansi-yellow-bg\">df</span>) <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> loader <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> loaders]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#ff2451a8 .cell execution_count=43}\n``` {.python .cell-code}\nspam[0].printSchema()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[43], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">spam</span>[<span style=\"color:rgb(98,98,98)\">0</span>]<span style=\"color:rgb(98,98,98)\">.</span>printSchema()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'spam' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#d9a38318 .cell execution_count=44}\n``` {.python .cell-code}\nall(spam[0].columns == it.columns for it in spam[1:])\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[44], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"color:rgb(0,135,0)\">all</span>(spam[<span style=\"color:rgb(98,98,98)\">0</span>]<span style=\"color:rgb(98,98,98)\">.</span>columns <span style=\"color:rgb(98,98,98)\">==</span> it<span style=\"color:rgb(98,98,98)\">.</span>columns <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> it <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> <span class=\"ansi-yellow-bg\">spam</span>[<span style=\"color:rgb(98,98,98)\">1</span>:])\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'spam' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#ccc39659 .cell execution_count=45}\n``` {.python .cell-code}\nlen(spam)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[45], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"color:rgb(0,135,0)\">len</span>(<span class=\"ansi-yellow-bg\">spam</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'spam' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#56f8cb61 .cell execution_count=46}\n``` {.python .cell-code}\ncsr = reduce(\n    lambda df1, df2: df1.union(df2),\n    spam\n)\n\ncsr.head(n=3)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[46], line 3</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> csr <span style=\"color:rgb(98,98,98)\">=</span> reduce(\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">lambda</span> df1, df2: df1<span style=\"color:rgb(98,98,98)\">.</span>union(df2),\n<span class=\"ansi-green-fg\">----&gt; 3</span>     <span class=\"ansi-yellow-bg\">spam</span>\n<span class=\"ansi-green-fg ansi-bold\">      4</span> )\n<span class=\"ansi-green-fg ansi-bold\">      6</span> csr<span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">3</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'spam' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#2f300488 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:25:54.862814Z\",\"start_time\":\"2020-05-03T15:25:54.857914Z\"}' execution_count=47}\n``` {.python .cell-code}\ncsr.columns\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[47], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">csr</span><span style=\"color:rgb(98,98,98)\">.</span>columns\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#0fb91801 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:26:13.629146Z\",\"start_time\":\"2020-05-03T15:25:55.683800Z\"}' execution_count=48}\n``` {.python .cell-code}\ncsr.show(5)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[48], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">csr</span><span style=\"color:rgb(98,98,98)\">.</span>show(<span style=\"color:rgb(98,98,98)\">5</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#afbc1b94 .cell execution_count=49}\n``` {.python .cell-code}\ncsr.rdd.getNumPartitions()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[49], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">csr</span><span style=\"color:rgb(98,98,98)\">.</span>rdd<span style=\"color:rgb(98,98,98)\">.</span>getNumPartitions()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#ecb56d85 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:30:20.643141Z\",\"start_time\":\"2020-05-03T15:29:45.221790Z\"}' execution_count=50}\n``` {.python .cell-code}\n# Replace features names and xid by a unique number\nfeature_name_partition = Window().orderBy('feature_name')\n\nxid_partition = Window().orderBy('xid')\n\ncol_idx = func.dense_rank().over(feature_name_partition)\nrow_idx = func.dense_rank().over(xid_partition)\n```\n:::\n\n\n::: {#3bdead53 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:30:20.643141Z\",\"start_time\":\"2020-05-03T15:29:45.221790Z\"}' execution_count=51}\n``` {.python .cell-code}\ncsr = csr.withColumn('col', col_idx)\\\n    .withColumn('row', row_idx)\n\ncsr = csr.na.drop('any')\n\ncsr.head(n=5)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[51], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> csr <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">csr</span><span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">col</span><span style=\"color:rgb(175,0,0)\">'</span>, col_idx)\\\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     <span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">row</span><span style=\"color:rgb(175,0,0)\">'</span>, row_idx)\n<span class=\"ansi-green-fg ansi-bold\">      4</span> csr <span style=\"color:rgb(98,98,98)\">=</span> csr<span style=\"color:rgb(98,98,98)\">.</span>na<span style=\"color:rgb(98,98,98)\">.</span>drop(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">any</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      6</span> csr<span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">5</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#dc008979 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:32:02.552364Z\",\"start_time\":\"2020-05-03T15:31:14.990298Z\"}' execution_count=52}\n``` {.python .cell-code}\n# Let's save the result of our hard work into a new parquet file\noutput_path = './'\noutput_file = os.path.join(output_path, 'csr.parquet')\ncsr.write.parquet(output_file, mode='overwrite')\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[52], line 4</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> output_path <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">./</span><span style=\"color:rgb(175,0,0)\">'</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> output_file <span style=\"color:rgb(98,98,98)\">=</span> os<span style=\"color:rgb(98,98,98)\">.</span>path<span style=\"color:rgb(98,98,98)\">.</span>join(output_path, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">csr.parquet</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg\">----&gt; 4</span> <span class=\"ansi-yellow-bg\">csr</span><span style=\"color:rgb(98,98,98)\">.</span>write<span style=\"color:rgb(98,98,98)\">.</span>parquet(output_file, mode<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">overwrite</span><span style=\"color:rgb(175,0,0)\">'</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n# Preparation of the training dataset\n\n::: {#461822b4 .cell execution_count=53}\n``` {.python .cell-code}\ncsr_path = './'\ncsr_file = os.path.join(csr_path, 'csr.parquet')\n\ndf = spark.read.parquet(csr_file)\ndf.head(n=5)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">AnalysisException</span>                         Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[53], line 4</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> csr_path <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">./</span><span style=\"color:rgb(175,0,0)\">'</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> csr_file <span style=\"color:rgb(98,98,98)\">=</span> os<span style=\"color:rgb(98,98,98)\">.</span>path<span style=\"color:rgb(98,98,98)\">.</span>join(csr_path, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">csr.parquet</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg\">----&gt; 4</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">spark</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">read</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">parquet</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">csr_file</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">      5</span> df<span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">5</span>)\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyspark/sql/readwriter.py:544</span>, in <span class=\"ansi-cyan-fg\">DataFrameReader.parquet</span><span class=\"ansi-blue-fg\">(self, *paths, **options)</span>\n<span class=\"ansi-green-fg ansi-bold\">    533</span> int96RebaseMode <span style=\"color:rgb(98,98,98)\">=</span> options<span style=\"color:rgb(98,98,98)\">.</span>get(<span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">int96RebaseMode</span><span style=\"color:rgb(175,0,0)\">\"</span>, <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>)\n<span class=\"ansi-green-fg ansi-bold\">    534</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_set_opts(\n<span class=\"ansi-green-fg ansi-bold\">    535</span>     mergeSchema<span style=\"color:rgb(98,98,98)\">=</span>mergeSchema,\n<span class=\"ansi-green-fg ansi-bold\">    536</span>     pathGlobFilter<span style=\"color:rgb(98,98,98)\">=</span>pathGlobFilter,\n<span class=\"ansi-green-fg\">   (...)</span>\n<span class=\"ansi-green-fg ansi-bold\">    541</span>     int96RebaseMode<span style=\"color:rgb(98,98,98)\">=</span>int96RebaseMode,\n<span class=\"ansi-green-fg ansi-bold\">    542</span> )\n<span class=\"ansi-green-fg\">--&gt; 544</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_df(<span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_jreader</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">parquet</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">_to_seq</span><span class=\"ansi-yellow-bg\">(</span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_spark</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_sc</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span class=\"ansi-yellow-bg\">paths</span><span class=\"ansi-yellow-bg\">)</span><span class=\"ansi-yellow-bg\">)</span>)\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/py4j/java_gateway.py:1322</span>, in <span class=\"ansi-cyan-fg\">JavaMember.__call__</span><span class=\"ansi-blue-fg\">(self, *args)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1316</span> command <span style=\"color:rgb(98,98,98)\">=</span> proto<span style=\"color:rgb(98,98,98)\">.</span>CALL_COMMAND_NAME <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1317</span>     <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>command_header <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1318</span>     args_command <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1319</span>     proto<span style=\"color:rgb(98,98,98)\">.</span>END_COMMAND_PART\n<span class=\"ansi-green-fg ansi-bold\">   1321</span> answer <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>gateway_client<span style=\"color:rgb(98,98,98)\">.</span>send_command(command)\n<span class=\"ansi-green-fg\">-&gt; 1322</span> return_value <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">get_return_value</span><span class=\"ansi-yellow-bg\">(</span>\n<span class=\"ansi-green-fg ansi-bold\">   1323</span> <span class=\"ansi-yellow-bg\">    </span><span class=\"ansi-yellow-bg\">answer</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">gateway_client</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">target_id</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">name</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1325</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> temp_arg <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> temp_args:\n<span class=\"ansi-green-fg ansi-bold\">   1326</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">hasattr</span>(temp_arg, <span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">_detach</span><span style=\"color:rgb(175,0,0)\">\"</span>):\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyspark/errors/exceptions/captured.py:185</span>, in <span class=\"ansi-cyan-fg\">capture_sql_exception.&lt;locals&gt;.deco</span><span class=\"ansi-blue-fg\">(*a, **kw)</span>\n<span class=\"ansi-green-fg ansi-bold\">    181</span> converted <span style=\"color:rgb(98,98,98)\">=</span> convert_exception(e<span style=\"color:rgb(98,98,98)\">.</span>java_exception)\n<span class=\"ansi-green-fg ansi-bold\">    182</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"font-weight:bold;color:rgb(175,0,255)\">not</span> <span style=\"color:rgb(0,135,0)\">isinstance</span>(converted, UnknownException):\n<span class=\"ansi-green-fg ansi-bold\">    183</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># Hide where the exception came from that shows a non-Pythonic</span>\n<span class=\"ansi-green-fg ansi-bold\">    184</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># JVM exception message.</span>\n<span class=\"ansi-green-fg\">--&gt; 185</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span> converted <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>\n<span class=\"ansi-green-fg ansi-bold\">    186</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">else</span>:\n<span class=\"ansi-green-fg ansi-bold\">    187</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span>\n\n<span class=\"ansi-red-fg\">AnalysisException</span>: [PATH_NOT_FOUND] Path does not exist: file:/home/boucheron/Documents/IFEBY310/core/notebooks/csr.parquet.</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#5010ad2a .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:17.229477Z\",\"start_time\":\"2020-05-03T15:33:16.995048Z\"}' execution_count=54}\n``` {.python .cell-code}\ndf.count()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[54], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>count()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#a15ef34f .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:20.881392Z\",\"start_time\":\"2020-05-03T15:33:19.624525Z\"}' execution_count=55}\n``` {.python .cell-code}\n# What are the features related to campaign_id 1204 ?\nfeatures_names = \\\n    df.select('feature_name')\\\n    .distinct()\\\n    .toPandas()['feature_name']\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[55], line 3</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># What are the features related to campaign_id 1204 ?</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> features_names <span style=\"color:rgb(98,98,98)\">=</span> \\\n<span class=\"ansi-green-fg\">----&gt; 3</span>     <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>select(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">feature_name</span><span style=\"color:rgb(175,0,0)\">'</span>)\\\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     <span style=\"color:rgb(98,98,98)\">.</span>distinct()\\\n<span class=\"ansi-green-fg ansi-bold\">      5</span>     <span style=\"color:rgb(98,98,98)\">.</span>toPandas()[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">feature_name</span><span style=\"color:rgb(175,0,0)\">'</span>]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#2b878a62 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:21.818568Z\",\"start_time\":\"2020-05-03T15:33:21.812810Z\"}' execution_count=56}\n``` {.python .cell-code}\nfeatures_names\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[56], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">features_names</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'features_names' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#1c5cd853 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:27.083141Z\",\"start_time\":\"2020-05-03T15:33:27.078374Z\"}' execution_count=57}\n``` {.python .cell-code}\n[feature_name for feature_name in features_names if '1204' in feature_name]\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[57], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> [feature_name <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> feature_name <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> <span class=\"ansi-yellow-bg\">features_names</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">1204</span><span style=\"color:rgb(175,0,0)\">'</span> <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> feature_name]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'features_names' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#5550c356 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:28.560631Z\",\"start_time\":\"2020-05-03T15:33:27.903921Z\"}' execution_count=58}\n``` {.python .cell-code}\n# Look for the xid that have at least one exposure to campaign 1204\nkeep = func.when(\n    (col('feature_name') == 'n_actions_per_category_id#C#1204.0') |\n    (col('feature_name') == 'n_actions_per_category_id#O#1204.0'),\n    1).otherwise(0)\ndf = df.withColumn('keep', keep)\n\ndf.where(col('keep') > 0).count()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[58], line 6</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># Look for the xid that have at least one exposure to campaign 1204</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> keep <span style=\"color:rgb(98,98,98)\">=</span> func<span style=\"color:rgb(98,98,98)\">.</span>when(\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     (col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">feature_name</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">==</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_actions_per_category_id#C#1204.0</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">|</span>\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     (col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">feature_name</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">==</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_actions_per_category_id#O#1204.0</span><span style=\"color:rgb(175,0,0)\">'</span>),\n<span class=\"ansi-green-fg ansi-bold\">      5</span>     <span style=\"color:rgb(98,98,98)\">1</span>)<span style=\"color:rgb(98,98,98)\">.</span>otherwise(<span style=\"color:rgb(98,98,98)\">0</span>)\n<span class=\"ansi-green-fg\">----&gt; 6</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">keep</span><span style=\"color:rgb(175,0,0)\">'</span>, keep)\n<span class=\"ansi-green-fg ansi-bold\">      8</span> df<span style=\"color:rgb(98,98,98)\">.</span>where(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">keep</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">&gt;</span> <span style=\"color:rgb(98,98,98)\">0</span>)<span style=\"color:rgb(98,98,98)\">.</span>count()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#d8609ae5 .cell execution_count=59}\n``` {.python .cell-code}\n# Sum of the keeps :)\nxid_partition = Window.partitionBy('xid')\nsum_keep = func.sum(col('keep')).over(xid_partition)\ndf = df.withColumn('sum_keep', sum_keep)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[59], line 4</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> xid_partition <span style=\"color:rgb(98,98,98)\">=</span> Window<span style=\"color:rgb(98,98,98)\">.</span>partitionBy(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">xid</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      3</span> sum_keep <span style=\"color:rgb(98,98,98)\">=</span> func<span style=\"color:rgb(98,98,98)\">.</span>sum(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">keep</span><span style=\"color:rgb(175,0,0)\">'</span>))<span style=\"color:rgb(98,98,98)\">.</span>over(xid_partition)\n<span class=\"ansi-green-fg\">----&gt; 4</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">sum_keep</span><span style=\"color:rgb(175,0,0)\">'</span>, sum_keep)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#7dccbc18 .cell execution_count=60}\n``` {.python .cell-code}\n# Let's keep the xid exposed to 1204\ndf = df.where(col('sum_keep') > 0)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[60], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># Let's keep the xid exposed to 1204</span>\n<span class=\"ansi-green-fg\">----&gt; 2</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>where(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">sum_keep</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">&gt;</span> <span style=\"color:rgb(98,98,98)\">0</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#51fba440 .cell execution_count=61}\n``` {.python .cell-code}\ndf.count()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[61], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>count()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#cbd92f17 .cell execution_count=62}\n``` {.python .cell-code}\ndf.select('xid').distinct().count()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[62], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>select(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">xid</span><span style=\"color:rgb(175,0,0)\">'</span>)<span style=\"color:rgb(98,98,98)\">.</span>distinct()<span style=\"color:rgb(98,98,98)\">.</span>count()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#6429d640 .cell execution_count=63}\n``` {.python .cell-code}\nrow_partition = Window().orderBy('row')\ncol_partition = Window().orderBy('col')\n\nrow_new = func.dense_rank().over(row_partition)\ncol_new = func.dense_rank().over(col_partition)\n\ndf = df.withColumn('row_new', row_new)\ndf = df.withColumn('col_new', col_new)\n\ncsr_data = df.select('row_new', 'col_new', 'value').toPandas()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[63], line 7</span>\n<span class=\"ansi-green-fg ansi-bold\">      4</span> row_new <span style=\"color:rgb(98,98,98)\">=</span> func<span style=\"color:rgb(98,98,98)\">.</span>dense_rank()<span style=\"color:rgb(98,98,98)\">.</span>over(row_partition)\n<span class=\"ansi-green-fg ansi-bold\">      5</span> col_new <span style=\"color:rgb(98,98,98)\">=</span> func<span style=\"color:rgb(98,98,98)\">.</span>dense_rank()<span style=\"color:rgb(98,98,98)\">.</span>over(col_partition)\n<span class=\"ansi-green-fg\">----&gt; 7</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">row_new</span><span style=\"color:rgb(175,0,0)\">'</span>, row_new)\n<span class=\"ansi-green-fg ansi-bold\">      8</span> df <span style=\"color:rgb(98,98,98)\">=</span> df<span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">col_new</span><span style=\"color:rgb(175,0,0)\">'</span>, col_new)\n<span class=\"ansi-green-fg ansi-bold\">     10</span> csr_data <span style=\"color:rgb(98,98,98)\">=</span> df<span style=\"color:rgb(98,98,98)\">.</span>select(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">row_new</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">col_new</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">value</span><span style=\"color:rgb(175,0,0)\">'</span>)<span style=\"color:rgb(98,98,98)\">.</span>toPandas()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#1af9ee88 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:52.617724Z\",\"start_time\":\"2020-05-03T15:33:52.609488Z\"}' execution_count=64}\n``` {.python .cell-code}\ncsr_data.head()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[64], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">csr_data</span><span style=\"color:rgb(98,98,98)\">.</span>head()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'csr_data' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#85032344 .cell execution_count=65}\n``` {.python .cell-code}\nfeatures_names = df.select('feature_name', 'col_new').distinct()\nfeatures_names.where(col('feature_name') == 'n_actions_per_category_id#C#1204.0').head()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[65], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> features_names <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>select(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">feature_name</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">col_new</span><span style=\"color:rgb(175,0,0)\">'</span>)<span style=\"color:rgb(98,98,98)\">.</span>distinct()\n<span class=\"ansi-green-fg ansi-bold\">      2</span> features_names<span style=\"color:rgb(98,98,98)\">.</span>where(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">feature_name</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">==</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_actions_per_category_id#C#1204.0</span><span style=\"color:rgb(175,0,0)\">'</span>)<span style=\"color:rgb(98,98,98)\">.</span>head()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#f854cf47 .cell execution_count=66}\n``` {.python .cell-code}\nfeatures_names.where(col('feature_name') == 'n_actions_per_category_id#O#1204.0').head()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[66], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">features_names</span><span style=\"color:rgb(98,98,98)\">.</span>where(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">feature_name</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">==</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_actions_per_category_id#O#1204.0</span><span style=\"color:rgb(175,0,0)\">'</span>)<span style=\"color:rgb(98,98,98)\">.</span>head()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'features_names' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#a59125d6 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:34:11.510538Z\",\"start_time\":\"2020-05-03T15:34:11.454802Z\"}' execution_count=67}\n``` {.python .cell-code}\nfrom scipy.sparse import csr_matrix\nimport numpy as np\n\nrows = csr_data['row_new'].values - 1\ncols = csr_data['col_new'].values - 1\nvals = csr_data['value'].values\n\nX_csr = csr_matrix((vals, (rows, cols)))\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[67], line 4</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">scipy</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">sparse</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> csr_matrix\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">numpy</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">np</span>\n<span class=\"ansi-green-fg\">----&gt; 4</span> rows <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">csr_data</span>[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">row_new</span><span style=\"color:rgb(175,0,0)\">'</span>]<span style=\"color:rgb(98,98,98)\">.</span>values <span style=\"color:rgb(98,98,98)\">-</span> <span style=\"color:rgb(98,98,98)\">1</span>\n<span class=\"ansi-green-fg ansi-bold\">      5</span> cols <span style=\"color:rgb(98,98,98)\">=</span> csr_data[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">col_new</span><span style=\"color:rgb(175,0,0)\">'</span>]<span style=\"color:rgb(98,98,98)\">.</span>values <span style=\"color:rgb(98,98,98)\">-</span> <span style=\"color:rgb(98,98,98)\">1</span>\n<span class=\"ansi-green-fg ansi-bold\">      6</span> vals <span style=\"color:rgb(98,98,98)\">=</span> csr_data[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">value</span><span style=\"color:rgb(175,0,0)\">'</span>]<span style=\"color:rgb(98,98,98)\">.</span>values\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'csr_data' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#531b3fbf .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:34:11.977267Z\",\"start_time\":\"2020-05-03T15:34:11.972602Z\"}' execution_count=68}\n``` {.python .cell-code}\nX_csr.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[68], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">X_csr</span><span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X_csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#f008aed4 .cell execution_count=69}\n``` {.python .cell-code}\nX_csr.shape, X_csr.nnz\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[69], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">X_csr</span><span style=\"color:rgb(98,98,98)\">.</span>shape, X_csr<span style=\"color:rgb(98,98,98)\">.</span>nnz\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X_csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#9600c6f5 .cell execution_count=70}\n``` {.python .cell-code}\nX_csr.nnz / (X_csr.shape[0]* X_csr.shape[1])   # 0152347 * 92)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[70], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">X_csr</span><span style=\"color:rgb(98,98,98)\">.</span>nnz <span style=\"color:rgb(98,98,98)\">/</span> (X_csr<span style=\"color:rgb(98,98,98)\">.</span>shape[<span style=\"color:rgb(98,98,98)\">0</span>]<span style=\"color:rgb(98,98,98)\">*</span> X_csr<span style=\"color:rgb(98,98,98)\">.</span>shape[<span style=\"color:rgb(98,98,98)\">1</span>])   <span style=\"font-style:italic;color:rgb(95,135,135)\"># 0152347 * 92)</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X_csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#3d035159 .cell execution_count=71}\n``` {.python .cell-code}\n# The label vector. Let's make it dense, flat and binary\ny = np.array(X_csr[:, 1].todense()).ravel()\ny = np.array(y > 0, dtype=np.int64)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[71], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># The label vector. Let's make it dense, flat and binary</span>\n<span class=\"ansi-green-fg\">----&gt; 2</span> y <span style=\"color:rgb(98,98,98)\">=</span> np<span style=\"color:rgb(98,98,98)\">.</span>array(<span class=\"ansi-yellow-bg\">X_csr</span>[:, <span style=\"color:rgb(98,98,98)\">1</span>]<span style=\"color:rgb(98,98,98)\">.</span>todense())<span style=\"color:rgb(98,98,98)\">.</span>ravel()\n<span class=\"ansi-green-fg ansi-bold\">      3</span> y <span style=\"color:rgb(98,98,98)\">=</span> np<span style=\"color:rgb(98,98,98)\">.</span>array(y <span style=\"color:rgb(98,98,98)\">&gt;</span> <span style=\"color:rgb(98,98,98)\">0</span>, dtype<span style=\"color:rgb(98,98,98)\">=</span>np<span style=\"color:rgb(98,98,98)\">.</span>int64)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X_csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#bf7ad455 .cell execution_count=72}\n``` {.python .cell-code}\nX_csr.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[72], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">X_csr</span><span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X_csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#2447ac72 .cell execution_count=73}\n``` {.python .cell-code}\n# We remove the second and fourth column. \n# It actually contain the label we'll want to predict.\nkept_cols = list(range(X_csr.shape[1]))\nkept_cols.pop(1)\nkept_cols.pop(2)\nX = X_csr[:, kept_cols]\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[73], line 3</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># We remove the second and fourth column. </span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># It actually contain the label we'll want to predict.</span>\n<span class=\"ansi-green-fg\">----&gt; 3</span> kept_cols <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">list</span>(<span style=\"color:rgb(0,135,0)\">range</span>(<span class=\"ansi-yellow-bg\">X_csr</span><span style=\"color:rgb(98,98,98)\">.</span>shape[<span style=\"color:rgb(98,98,98)\">1</span>]))\n<span class=\"ansi-green-fg ansi-bold\">      4</span> kept_cols<span style=\"color:rgb(98,98,98)\">.</span>pop(<span style=\"color:rgb(98,98,98)\">1</span>)\n<span class=\"ansi-green-fg ansi-bold\">      5</span> kept_cols<span style=\"color:rgb(98,98,98)\">.</span>pop(<span style=\"color:rgb(98,98,98)\">2</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X_csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#35d8d746 .cell execution_count=74}\n``` {.python .cell-code}\nlen(kept_cols)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[74], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"color:rgb(0,135,0)\">len</span>(<span class=\"ansi-yellow-bg\">kept_cols</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'kept_cols' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#06b59ca9 .cell execution_count=75}\n``` {.python .cell-code}\nX_csr.shape, X.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[75], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">X_csr</span><span style=\"color:rgb(98,98,98)\">.</span>shape, X<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X_csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n## Finally !!\n\nWow ! That was a lot of work. Now we have a features matrix $X$ and a vector of labels $y$.\n\n::: {#b7ce00cf .cell execution_count=76}\n``` {.python .cell-code}\nX.indices\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[76], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">X</span><span style=\"color:rgb(98,98,98)\">.</span>indices\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#f799d32e .cell execution_count=77}\n``` {.python .cell-code}\nX.indptr\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[77], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">X</span><span style=\"color:rgb(98,98,98)\">.</span>indptr\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#a94f18d8 .cell execution_count=78}\n``` {.python .cell-code}\nX.shape, X.nnz\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[78], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">X</span><span style=\"color:rgb(98,98,98)\">.</span>shape, X<span style=\"color:rgb(98,98,98)\">.</span>nnz\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#8ef6f596 .cell execution_count=79}\n``` {.python .cell-code}\ny.shape, y.sum()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[79], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">y</span><span style=\"color:rgb(98,98,98)\">.</span>shape, y<span style=\"color:rgb(98,98,98)\">.</span>sum()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'y' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n# Some learning for/from this data\n\n::: {#52c94072 .cell execution_count=80}\n``` {.python .cell-code}\nfrom sklearn.preprocessing import MaxAbsScaler\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.linear_model import LogisticRegression\n\n# Normalize the features\nX = MaxAbsScaler().fit_transform(X)\nX_train, X_test, y_train, y_test = train_test_split(X, y, stratify=y, test_size=0.3)\n\nclf = LogisticRegression(\n    penalty='l2',\n    C=1e3,\n    solver='lbfgs',\n    class_weight='balanced'\n)\n\nclf.fit(X_train, y_train)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[80], line 6</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">sklearn</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">linear_model</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> LogisticRegression\n<span class=\"ansi-green-fg ansi-bold\">      5</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># Normalize the features</span>\n<span class=\"ansi-green-fg\">----&gt; 6</span> X <span style=\"color:rgb(98,98,98)\">=</span> MaxAbsScaler()<span style=\"color:rgb(98,98,98)\">.</span>fit_transform(<span class=\"ansi-yellow-bg\">X</span>)\n<span class=\"ansi-green-fg ansi-bold\">      7</span> X_train, X_test, y_train, y_test <span style=\"color:rgb(98,98,98)\">=</span> train_test_split(X, y, stratify<span style=\"color:rgb(98,98,98)\">=</span>y, test_size<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">0.3</span>)\n<span class=\"ansi-green-fg ansi-bold\">      9</span> clf <span style=\"color:rgb(98,98,98)\">=</span> LogisticRegression(\n<span class=\"ansi-green-fg ansi-bold\">     10</span>     penalty<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">l2</span><span style=\"color:rgb(175,0,0)\">'</span>,\n<span class=\"ansi-green-fg ansi-bold\">     11</span>     C<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1e3</span>,\n<span class=\"ansi-green-fg ansi-bold\">     12</span>     solver<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">lbfgs</span><span style=\"color:rgb(175,0,0)\">'</span>,\n<span class=\"ansi-green-fg ansi-bold\">     13</span>     class_weight<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">balanced</span><span style=\"color:rgb(175,0,0)\">'</span>\n<span class=\"ansi-green-fg ansi-bold\">     14</span> )\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#9716cc3a .cell execution_count=81}\n``` {.python .cell-code}\nfeatures_names = features_names.toPandas()['feature_name']\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[81], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> features_names <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">features_names</span><span style=\"color:rgb(98,98,98)\">.</span>toPandas()[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">feature_name</span><span style=\"color:rgb(175,0,0)\">'</span>]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'features_names' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#3f420622 .cell execution_count=82}\n``` {.python .cell-code}\nfeatures_names[range(6)]\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[82], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">features_names</span>[<span style=\"color:rgb(0,135,0)\">range</span>(<span style=\"color:rgb(98,98,98)\">6</span>)]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'features_names' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#b61c59cf .cell execution_count=83}\n``` {.python .cell-code}\nimport matplotlib.pyplot as plt\n%matplotlib inline\n```\n:::\n\n\n::: {#0c9c2b76 .cell execution_count=84}\n``` {.python .cell-code}\nplt.figure(figsize=(16, 5))\nplt.stem(clf.coef_[0]) # , use_line_collection=True)\nplt.title('Logistic regression coefficients', fontsize=18)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[84], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> plt<span style=\"color:rgb(98,98,98)\">.</span>figure(figsize<span style=\"color:rgb(98,98,98)\">=</span>(<span style=\"color:rgb(98,98,98)\">16</span>, <span style=\"color:rgb(98,98,98)\">5</span>))\n<span class=\"ansi-green-fg\">----&gt; 2</span> plt<span style=\"color:rgb(98,98,98)\">.</span>stem(<span class=\"ansi-yellow-bg\">clf</span><span style=\"color:rgb(98,98,98)\">.</span>coef_[<span style=\"color:rgb(98,98,98)\">0</span>]) <span style=\"font-style:italic;color:rgb(95,135,135)\"># , use_line_collection=True)</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> plt<span style=\"color:rgb(98,98,98)\">.</span>title(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">Logistic regression coefficients</span><span style=\"color:rgb(175,0,0)\">'</span>, fontsize<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">18</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'clf' is not defined</pre>\n```\n:::\n\n:::\n\n::: {.cell-output .cell-output-display}\n```\n<Figure size 1536x480 with 0 Axes>\n```\n:::\n:::\n\n\n::: {#77affede .cell execution_count=85}\n``` {.python .cell-code}\nclf.coef_[0].shape[0]\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[85], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">clf</span><span style=\"color:rgb(98,98,98)\">.</span>coef_[<span style=\"color:rgb(98,98,98)\">0</span>]<span style=\"color:rgb(98,98,98)\">.</span>shape[<span style=\"color:rgb(98,98,98)\">0</span>]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'clf' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#dabb95de .cell execution_count=86}\n``` {.python .cell-code}\nlen(features_names)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[86], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"color:rgb(0,135,0)\">len</span>(<span class=\"ansi-yellow-bg\">features_names</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'features_names' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#29cb9570 .cell execution_count=87}\n``` {.python .cell-code}\n# We change the fontsize of minor ticks label\n_ = plt.xticks(np.arange(clf.coef_[0].shape[0]), features_names, \n           rotation='vertical', fontsize=8)\n```\n:::\n\n\n::: {#86d491d2 .cell execution_count=88}\n``` {.python .cell-code}\n_ = plt.yticks(fontsize=14)\n```\n\n::: {.cell-output .cell-output-display}\n![](notebook08_webdata-II_files/figure-html/cell-89-output-1.png){width=590 height=418}\n:::\n:::\n\n\n::: {#ad9e6d86 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:51:25.280157Z\",\"start_time\":\"2020-05-03T15:51:25.081464Z\"}' execution_count=89}\n``` {.python .cell-code}\nfrom sklearn.metrics import precision_recall_curve, f1_score\n\nprecision, recall, _ = precision_recall_curve(y_test, clf.predict_proba(X_test)[:, 1])\n    \nplt.figure(figsize=(8, 6))\nplt.plot(recall, precision, label='LR (F1=%.2f)' % f1_score(y_test, clf.predict(X_test)), lw=2)\nplt.xlim([0.0, 1.0])\nplt.ylim([0.0, 1.05])\nplt.xlabel('Recall', fontsize=16)\nplt.ylabel('Precision', fontsize=16)\nplt.title('Precision/recall curve', fontsize=18)\nplt.legend(loc=\"upper right\", fontsize=14)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[88], line 3</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">sklearn</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">metrics</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> precision_recall_curve, f1_score\n<span class=\"ansi-green-fg\">----&gt; 3</span> precision, recall, _ <span style=\"color:rgb(98,98,98)\">=</span> precision_recall_curve(<span class=\"ansi-yellow-bg\">y_test</span>, clf<span style=\"color:rgb(98,98,98)\">.</span>predict_proba(X_test)[:, <span style=\"color:rgb(98,98,98)\">1</span>])\n<span class=\"ansi-green-fg ansi-bold\">      5</span> plt<span style=\"color:rgb(98,98,98)\">.</span>figure(figsize<span style=\"color:rgb(98,98,98)\">=</span>(<span style=\"color:rgb(98,98,98)\">8</span>, <span style=\"color:rgb(98,98,98)\">6</span>))\n<span class=\"ansi-green-fg ansi-bold\">      6</span> plt<span style=\"color:rgb(98,98,98)\">.</span>plot(recall, precision, label<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">LR (F1=</span><span style=\"font-weight:bold;color:rgb(175,95,135)\">%.2f</span><span style=\"color:rgb(175,0,0)\">)</span><span style=\"color:rgb(175,0,0)\">'</span> <span style=\"color:rgb(98,98,98)\">%</span> f1_score(y_test, clf<span style=\"color:rgb(98,98,98)\">.</span>predict(X_test)), lw<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'y_test' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n# Analyse the tables \n\n::: {#475e422c .cell execution_count=90}\n``` {.python .cell-code}\nquery = \"\"\"ANALYZE TABLE db_table COMPUTE STATISTICS\n            FOR COLUMNS xid\"\"\"\n```\n:::\n\n\n::: {#fadbd4b4 .cell execution_count=91}\n``` {.python .cell-code}\ndf.createOrReplaceTempView(\"db_table\")\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[90], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>createOrReplaceTempView(<span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">db_table</span><span style=\"color:rgb(175,0,0)\">\"</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#d8e12f2d .cell execution_count=92}\n``` {.python .cell-code}\ndf.columns\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[91], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>columns\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#443fae25 .cell execution_count=93}\n``` {.python .cell-code}\nspark.sql(\"cache table db_table\")\n```\n:::\n\n\n::: {#2f95f96a .cell execution_count=94}\n``` {.python .cell-code}\nspark.sql(query)\n```\n:::\n\n\n::: {#b3e379c9 .cell execution_count=95}\n``` {.python .cell-code}\nspark.sql(\"show tables\")\n```\n:::\n\n\n",
    "supporting": [
      "notebook08_webdata-II_files"
    ],
    "filters": [],
    "includes": {}
  }
}