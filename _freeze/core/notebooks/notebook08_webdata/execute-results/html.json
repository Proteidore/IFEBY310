{
  "hash": "a2a7c6dd6d08f86e6070a01e719674fb",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Using with `pyspark` for data preprocessing\njupyter: python3\nexecute: \n  eval: true\n---\n\n\nWe want to use pyspark to preprocess a potentially huge dataset used for web-marketing.\n\n## Data description\n\nThe data is a `parquet` file which contains a dataframe with 8 columns:\n\n- `xid`: unique user id\n- `action`: type of action. 'C' is a click, 'O' or 'VSL' is a web-display\n- `date`: date of the action\n- `website_id`: unique id of the website\n- `url`: url of the webpage\n- `category_id`: id of the display\n- `zipcode`: postal zipcode of the user\n- `device`: type of device used by the user\n\n## Q1. Some statistics / computations\n\nUsing `pyspark.sql` we want to do the following things:\n\n1. Compute the total number of unique users\n2. Construct a column containing the total number of actions per user\n3. Construct a column containing the number of days since the last action of the user\n4. Construct a column containing the number of actions of each user for each modality of device \n\n## Q2. Binary classification\n\nThen, we want to construct a classifier to predict the click on the category 1204. \nHere is an agenda for this:\n\n1. Construction of a features matrix for which each line corresponds to the information concerning a user.\n2. In this matrix, we need to keep only the users that have been exposed to the display in category 1204\n3. Using this training dataset, train a binary classifier, and evaluate your classifier using a precision / recall curve computed on test data.\n\n\n# Download/read the data and a first look at the data\n\n::: {#643cba18 .cell execution_count=1}\n``` {.python .cell-code}\nimport os\nimport sys\n\nos.environ['PYSPARK_PYTHON'] = sys.executable\nos.environ['PYSPARK_DRIVER_PYTHON'] = sys.executable\n```\n:::\n\n\n::: {#883cd216 .cell ExecuteTime='{\"end_time\":\"2020-05-03T16:25:56.650024Z\",\"start_time\":\"2020-05-03T16:25:52.400542Z\"}' execution_count=2}\n``` {.python .cell-code}\nfrom pyspark.sql import SparkSession\n```\n:::\n\n\n::: {.callout-note}\n\n### Spark in standalone mode\n\nSo far, we used the `local` mode. \n\nTo launch spark in standalone mode, assuming the current working directory is `$SPARK_HOME` \n\n```{.bash}\n$ ./sbin/sWe may tart-master.sh --ip localhost\n>>> starting org.apache.spark.deploy.master.Master, logging to ...\n$ ./sbin/start-worker.sh spark://localhost:7077\n```\n\nWe may now launch the  instance of `SparkSession`, setting explicitly the `master` node and the port to communicate with the master.\n\nSparkUI should be reachable at `localhost:4040`. \n\nThe master can be monitored at `localhost:8080`\n\n:::\n\n::: {#f0413ada .cell execution_count=3}\n``` {.python .cell-code}\nfrom pyspark import SparkConf, SparkContext\nfrom pyspark.sql import SparkSession\nfrom pyspark.sql import functions as fn\nfrom pyspark.sql.functions import col\n\nspark = (SparkSession\n    .builder\n    .appName(\"Taming Webdata\")\n    .getOrCreate()\n)\n\nsc = spark._sc\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n25/03/10 17:15:29 WARN Utils: Your hostname, boucheron-Precision-5480 resolves to a loopback address: 127.0.1.1; using 172.23.32.10 instead (on interface enxac91a1bd3e89)\n25/03/10 17:15:29 WARN Utils: Set SPARK_LOCAL_IP if you need to bind to another address\nSetting default log level to \"WARN\".\nTo adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).\n25/03/10 17:15:29 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable\n25/03/10 17:15:30 WARN Utils: Service 'SparkUI' could not bind on port 4040. Attempting port 4041.\n```\n:::\n:::\n\n\n::: {#3f3520a5 .cell execution_count=4}\n``` {.python .cell-code}\nspark = SparkSession.builder \\\n            .appName(\"Spark webdata\") \\\n            .master(\"spark://localhost:7077\") \\\n            .config(\"spark.driver.memory\", \"16G\") \\\n            .config(\"spark.serializer\", \"org.apache.spark.serializer.KryoSerializer\") \\\n            .config(\"spark.kryoserializer.buffer.max\", \"2000M\") \\\n            .config(\"spark.driver.maxResultSize\", \"0\") \\\n            .config(\"spark.jars.packages\", \"com.johnsnowlabs.nlp:spark-nlp_2.12:5.2.3\") \\\n            .getOrCreate()\n```\n:::\n\n\n::: {#e9491c77 .cell ExecuteTime='{\"end_time\":\"2020-05-03T16:25:56.650024Z\",\"start_time\":\"2020-05-03T16:25:52.400542Z\"}' execution_count=5}\n``` {.python .cell-code}\n#spark = (SparkSession\n#    .builder\n#    .appName(\"Web data\")         \n#    .getOrCreate()\n#)\n```\n:::\n\n\n::: {#ca2bcb35 .cell ExecuteTime='{\"end_time\":\"2020-05-03T16:28:38.406210Z\",\"start_time\":\"2020-05-03T16:28:08.594803Z\"}' execution_count=6}\n``` {.python .cell-code}\nimport requests, zipfile, io\nfrom pathlib import Path\n\npath = Path('data/webdata.parquet')\nif not path.exists():\n    url = \"https://s-v-b.github.io/IFEBY310/data/webdata.parquet.zip\"\n    r = requests.get(url)\n    z = zipfile.ZipFile(io.BytesIO(r.content))\n    z.extractall(path='data/')\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">BadZipFile</span>                                Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[5], line 8</span>\n<span class=\"ansi-green-fg ansi-bold\">      6</span> url <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">https://s-v-b.github.io/IFEBY310/data/webdata.parquet.zip</span><span style=\"color:rgb(175,0,0)\">\"</span>\n<span class=\"ansi-green-fg ansi-bold\">      7</span> r <span style=\"color:rgb(98,98,98)\">=</span> requests<span style=\"color:rgb(98,98,98)\">.</span>get(url)\n<span class=\"ansi-green-fg\">----&gt; 8</span> z <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">zipfile</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">ZipFile</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">io</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">BytesIO</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">r</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">content</span><span class=\"ansi-yellow-bg\">)</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">      9</span> z<span style=\"color:rgb(98,98,98)\">.</span>extractall(path<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">data/</span><span style=\"color:rgb(175,0,0)\">'</span>)\n\nFile <span class=\"ansi-green-fg\">/usr/lib/python3.12/zipfile/__init__.py:1349</span>, in <span class=\"ansi-cyan-fg\">ZipFile.__init__</span><span class=\"ansi-blue-fg\">(self, file, mode, compression, allowZip64, compresslevel, strict_timestamps, metadata_encoding)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1347</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">try</span>:\n<span class=\"ansi-green-fg ansi-bold\">   1348</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> mode <span style=\"color:rgb(98,98,98)\">==</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">r</span><span style=\"color:rgb(175,0,0)\">'</span>:\n<span class=\"ansi-green-fg\">-&gt; 1349</span>         <span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_RealGetContents</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1350</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">elif</span> mode <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> (<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">w</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">x</span><span style=\"color:rgb(175,0,0)\">'</span>):\n<span class=\"ansi-green-fg ansi-bold\">   1351</span>         <span style=\"font-style:italic;color:rgb(95,135,135)\"># set the modified flag so central directory gets written</span>\n<span class=\"ansi-green-fg ansi-bold\">   1352</span>         <span style=\"font-style:italic;color:rgb(95,135,135)\"># even if no files are added to the archive</span>\n<span class=\"ansi-green-fg ansi-bold\">   1353</span>         <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_didModify <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">True</span>\n\nFile <span class=\"ansi-green-fg\">/usr/lib/python3.12/zipfile/__init__.py:1416</span>, in <span class=\"ansi-cyan-fg\">ZipFile._RealGetContents</span><span class=\"ansi-blue-fg\">(self)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1414</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span> BadZipFile(<span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">File is not a zip file</span><span style=\"color:rgb(175,0,0)\">\"</span>)\n<span class=\"ansi-green-fg ansi-bold\">   1415</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"font-weight:bold;color:rgb(175,0,255)\">not</span> endrec:\n<span class=\"ansi-green-fg\">-&gt; 1416</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span> BadZipFile(<span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">File is not a zip file</span><span style=\"color:rgb(175,0,0)\">\"</span>)\n<span class=\"ansi-green-fg ansi-bold\">   1417</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>debug <span style=\"color:rgb(98,98,98)\">&gt;</span> <span style=\"color:rgb(98,98,98)\">1</span>:\n<span class=\"ansi-green-fg ansi-bold\">   1418</span>     <span style=\"color:rgb(0,135,0)\">print</span>(endrec)\n\n<span class=\"ansi-red-fg\">BadZipFile</span>: File is not a zip file</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#47877d16 .cell ExecuteTime='{\"end_time\":\"2020-05-03T16:27:49.141388Z\",\"start_time\":\"2020-05-03T16:27:48.989135Z\"}' execution_count=7}\n``` {.python .cell-code}\ninput_path = Path('./data')\ninput_file =  'webdata.parquet'\nfile_path = str(input_path / input_file)\n\ndf = spark.read.parquet(file_path)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">AnalysisException</span>                         Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[6], line 5</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> input_file <span style=\"color:rgb(98,98,98)\">=</span>  <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">webdata.parquet</span><span style=\"color:rgb(175,0,0)\">'</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> file_path <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">str</span>(input_path <span style=\"color:rgb(98,98,98)\">/</span> input_file)\n<span class=\"ansi-green-fg\">----&gt; 5</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">spark</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">read</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">parquet</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">file_path</span><span class=\"ansi-yellow-bg\">)</span>\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyspark/sql/readwriter.py:544</span>, in <span class=\"ansi-cyan-fg\">DataFrameReader.parquet</span><span class=\"ansi-blue-fg\">(self, *paths, **options)</span>\n<span class=\"ansi-green-fg ansi-bold\">    533</span> int96RebaseMode <span style=\"color:rgb(98,98,98)\">=</span> options<span style=\"color:rgb(98,98,98)\">.</span>get(<span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">int96RebaseMode</span><span style=\"color:rgb(175,0,0)\">\"</span>, <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>)\n<span class=\"ansi-green-fg ansi-bold\">    534</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_set_opts(\n<span class=\"ansi-green-fg ansi-bold\">    535</span>     mergeSchema<span style=\"color:rgb(98,98,98)\">=</span>mergeSchema,\n<span class=\"ansi-green-fg ansi-bold\">    536</span>     pathGlobFilter<span style=\"color:rgb(98,98,98)\">=</span>pathGlobFilter,\n<span class=\"ansi-green-fg\">   (...)</span>\n<span class=\"ansi-green-fg ansi-bold\">    541</span>     int96RebaseMode<span style=\"color:rgb(98,98,98)\">=</span>int96RebaseMode,\n<span class=\"ansi-green-fg ansi-bold\">    542</span> )\n<span class=\"ansi-green-fg\">--&gt; 544</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_df(<span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_jreader</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">parquet</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">_to_seq</span><span class=\"ansi-yellow-bg\">(</span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_spark</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_sc</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span class=\"ansi-yellow-bg\">paths</span><span class=\"ansi-yellow-bg\">)</span><span class=\"ansi-yellow-bg\">)</span>)\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/py4j/java_gateway.py:1322</span>, in <span class=\"ansi-cyan-fg\">JavaMember.__call__</span><span class=\"ansi-blue-fg\">(self, *args)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1316</span> command <span style=\"color:rgb(98,98,98)\">=</span> proto<span style=\"color:rgb(98,98,98)\">.</span>CALL_COMMAND_NAME <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1317</span>     <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>command_header <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1318</span>     args_command <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1319</span>     proto<span style=\"color:rgb(98,98,98)\">.</span>END_COMMAND_PART\n<span class=\"ansi-green-fg ansi-bold\">   1321</span> answer <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>gateway_client<span style=\"color:rgb(98,98,98)\">.</span>send_command(command)\n<span class=\"ansi-green-fg\">-&gt; 1322</span> return_value <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">get_return_value</span><span class=\"ansi-yellow-bg\">(</span>\n<span class=\"ansi-green-fg ansi-bold\">   1323</span> <span class=\"ansi-yellow-bg\">    </span><span class=\"ansi-yellow-bg\">answer</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">gateway_client</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">target_id</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">name</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1325</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> temp_arg <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> temp_args:\n<span class=\"ansi-green-fg ansi-bold\">   1326</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">hasattr</span>(temp_arg, <span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">_detach</span><span style=\"color:rgb(175,0,0)\">\"</span>):\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyspark/errors/exceptions/captured.py:185</span>, in <span class=\"ansi-cyan-fg\">capture_sql_exception.&lt;locals&gt;.deco</span><span class=\"ansi-blue-fg\">(*a, **kw)</span>\n<span class=\"ansi-green-fg ansi-bold\">    181</span> converted <span style=\"color:rgb(98,98,98)\">=</span> convert_exception(e<span style=\"color:rgb(98,98,98)\">.</span>java_exception)\n<span class=\"ansi-green-fg ansi-bold\">    182</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"font-weight:bold;color:rgb(175,0,255)\">not</span> <span style=\"color:rgb(0,135,0)\">isinstance</span>(converted, UnknownException):\n<span class=\"ansi-green-fg ansi-bold\">    183</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># Hide where the exception came from that shows a non-Pythonic</span>\n<span class=\"ansi-green-fg ansi-bold\">    184</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># JVM exception message.</span>\n<span class=\"ansi-green-fg\">--&gt; 185</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span> converted <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>\n<span class=\"ansi-green-fg ansi-bold\">    186</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">else</span>:\n<span class=\"ansi-green-fg ansi-bold\">    187</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span>\n\n<span class=\"ansi-red-fg\">AnalysisException</span>: [PATH_NOT_FOUND] Path does not exist: file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.parquet.</pre>\n```\n:::\n\n:::\n:::\n\n\nWe can give a try to Pandas on Spark\n\n::: {.callout-note}\n\nWe can also give a try to `pyarrow.parquet` module to load the Parquet file in an Arrow table.\n\n:::\n\n::: {#782d1d19 .cell execution_count=8}\n``` {.python .cell-code}\nimport pyarrow as pa\nimport comet as co\nimport pyarrow.parquet as pq\n\ndfa = pq.read_table(file_path)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">FileNotFoundError</span>                         Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[7], line 5</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">comet</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">co</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">pyarrow</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">parquet</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">pq</span>\n<span class=\"ansi-green-fg\">----&gt; 5</span> dfa <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">pq</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">read_table</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">file_path</span><span class=\"ansi-yellow-bg\">)</span>\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyarrow/parquet/core.py:1793</span>, in <span class=\"ansi-cyan-fg\">read_table</span><span class=\"ansi-blue-fg\">(source, columns, use_threads, schema, use_pandas_metadata, read_dictionary, memory_map, buffer_size, partitioning, filesystem, filters, use_legacy_dataset, ignore_prefixes, pre_buffer, coerce_int96_timestamp_unit, decryption_properties, thrift_string_size_limit, thrift_container_size_limit, page_checksum_verification)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1787</span>     warnings<span style=\"color:rgb(98,98,98)\">.</span>warn(\n<span class=\"ansi-green-fg ansi-bold\">   1788</span>         <span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">Passing </span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">use_legacy_dataset</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\"> is deprecated as of pyarrow 15.0.0 </span><span style=\"color:rgb(175,0,0)\">\"</span>\n<span class=\"ansi-green-fg ansi-bold\">   1789</span>         <span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">and will be removed in a future version.</span><span style=\"color:rgb(175,0,0)\">\"</span>,\n<span class=\"ansi-green-fg ansi-bold\">   1790</span>         <span style=\"font-weight:bold;color:rgb(215,95,95)\">FutureWarning</span>, stacklevel<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>)\n<span class=\"ansi-green-fg ansi-bold\">   1792</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">try</span>:\n<span class=\"ansi-green-fg\">-&gt; 1793</span>     dataset <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">ParquetDataset</span><span class=\"ansi-yellow-bg\">(</span>\n<span class=\"ansi-green-fg ansi-bold\">   1794</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">source</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1795</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">schema</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">schema</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1796</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">filesystem</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">filesystem</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1797</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">partitioning</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">partitioning</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1798</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">memory_map</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">memory_map</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1799</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">read_dictionary</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">read_dictionary</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1800</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">buffer_size</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">buffer_size</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1801</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">filters</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">filters</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1802</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">ignore_prefixes</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">ignore_prefixes</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1803</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">pre_buffer</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">pre_buffer</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1804</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">coerce_int96_timestamp_unit</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">coerce_int96_timestamp_unit</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1805</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">decryption_properties</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">decryption_properties</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1806</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">thrift_string_size_limit</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">thrift_string_size_limit</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1807</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">thrift_container_size_limit</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">thrift_container_size_limit</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1808</span> <span class=\"ansi-yellow-bg\">        </span><span class=\"ansi-yellow-bg\">page_checksum_verification</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">page_checksum_verification</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1809</span> <span class=\"ansi-yellow-bg\">    </span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1810</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">except</span> <span style=\"font-weight:bold;color:rgb(215,95,95)\">ImportError</span>:\n<span class=\"ansi-green-fg ansi-bold\">   1811</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># fall back on ParquetFile for simple cases when pyarrow.dataset</span>\n<span class=\"ansi-green-fg ansi-bold\">   1812</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># module is not available</span>\n<span class=\"ansi-green-fg ansi-bold\">   1813</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> filters <span style=\"font-weight:bold;color:rgb(175,0,255)\">is</span> <span style=\"font-weight:bold;color:rgb(175,0,255)\">not</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>:\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyarrow/parquet/core.py:1371</span>, in <span class=\"ansi-cyan-fg\">ParquetDataset.__init__</span><span class=\"ansi-blue-fg\">(self, path_or_paths, filesystem, schema, filters, read_dictionary, memory_map, buffer_size, partitioning, ignore_prefixes, pre_buffer, coerce_int96_timestamp_unit, decryption_properties, thrift_string_size_limit, thrift_container_size_limit, page_checksum_verification, use_legacy_dataset)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1367</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> partitioning <span style=\"color:rgb(98,98,98)\">==</span> <span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">hive</span><span style=\"color:rgb(175,0,0)\">\"</span>:\n<span class=\"ansi-green-fg ansi-bold\">   1368</span>     partitioning <span style=\"color:rgb(98,98,98)\">=</span> ds<span style=\"color:rgb(98,98,98)\">.</span>HivePartitioning<span style=\"color:rgb(98,98,98)\">.</span>discover(\n<span class=\"ansi-green-fg ansi-bold\">   1369</span>         infer_dictionary<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">True</span>)\n<span class=\"ansi-green-fg\">-&gt; 1371</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_dataset <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">ds</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">dataset</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">path_or_paths</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span class=\"ansi-yellow-bg\">filesystem</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">filesystem</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1372</span> <span class=\"ansi-yellow-bg\">                           </span><span class=\"ansi-yellow-bg\">schema</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">schema</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">format</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">parquet_format</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1373</span> <span class=\"ansi-yellow-bg\">                           </span><span class=\"ansi-yellow-bg\">partitioning</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">partitioning</span><span class=\"ansi-yellow-bg\">,</span>\n<span class=\"ansi-green-fg ansi-bold\">   1374</span> <span class=\"ansi-yellow-bg\">                           </span><span class=\"ansi-yellow-bg\">ignore_prefixes</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">=</span><span class=\"ansi-yellow-bg\">ignore_prefixes</span><span class=\"ansi-yellow-bg\">)</span>\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyarrow/dataset.py:794</span>, in <span class=\"ansi-cyan-fg\">dataset</span><span class=\"ansi-blue-fg\">(source, schema, format, filesystem, partitioning, partition_base_dir, exclude_invalid_files, ignore_prefixes)</span>\n<span class=\"ansi-green-fg ansi-bold\">    783</span> kwargs <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">dict</span>(\n<span class=\"ansi-green-fg ansi-bold\">    784</span>     schema<span style=\"color:rgb(98,98,98)\">=</span>schema,\n<span class=\"ansi-green-fg ansi-bold\">    785</span>     filesystem<span style=\"color:rgb(98,98,98)\">=</span>filesystem,\n<span class=\"ansi-green-fg\">   (...)</span>\n<span class=\"ansi-green-fg ansi-bold\">    790</span>     selector_ignore_prefixes<span style=\"color:rgb(98,98,98)\">=</span>ignore_prefixes\n<span class=\"ansi-green-fg ansi-bold\">    791</span> )\n<span class=\"ansi-green-fg ansi-bold\">    793</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> _is_path_like(source):\n<span class=\"ansi-green-fg\">--&gt; 794</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> <span class=\"ansi-yellow-bg\">_filesystem_dataset</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">source</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">*</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">*</span><span class=\"ansi-yellow-bg\">kwargs</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">    795</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">elif</span> <span style=\"color:rgb(0,135,0)\">isinstance</span>(source, (<span style=\"color:rgb(0,135,0)\">tuple</span>, <span style=\"color:rgb(0,135,0)\">list</span>)):\n<span class=\"ansi-green-fg ansi-bold\">    796</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">all</span>(_is_path_like(elem) <span style=\"font-weight:bold;color:rgb(175,0,255)\">or</span> <span style=\"color:rgb(0,135,0)\">isinstance</span>(elem, FileInfo) <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> elem <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> source):\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyarrow/dataset.py:476</span>, in <span class=\"ansi-cyan-fg\">_filesystem_dataset</span><span class=\"ansi-blue-fg\">(source, schema, filesystem, partitioning, format, partition_base_dir, exclude_invalid_files, selector_ignore_prefixes)</span>\n<span class=\"ansi-green-fg ansi-bold\">    474</span>         fs, paths_or_selector <span style=\"color:rgb(98,98,98)\">=</span> _ensure_multiple_sources(source, filesystem)\n<span class=\"ansi-green-fg ansi-bold\">    475</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">else</span>:\n<span class=\"ansi-green-fg\">--&gt; 476</span>     fs, paths_or_selector <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">_ensure_single_source</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">source</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span class=\"ansi-yellow-bg\">filesystem</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">    478</span> options <span style=\"color:rgb(98,98,98)\">=</span> FileSystemFactoryOptions(\n<span class=\"ansi-green-fg ansi-bold\">    479</span>     partitioning<span style=\"color:rgb(98,98,98)\">=</span>partitioning,\n<span class=\"ansi-green-fg ansi-bold\">    480</span>     partition_base_dir<span style=\"color:rgb(98,98,98)\">=</span>partition_base_dir,\n<span class=\"ansi-green-fg ansi-bold\">    481</span>     exclude_invalid_files<span style=\"color:rgb(98,98,98)\">=</span>exclude_invalid_files,\n<span class=\"ansi-green-fg ansi-bold\">    482</span>     selector_ignore_prefixes<span style=\"color:rgb(98,98,98)\">=</span>selector_ignore_prefixes\n<span class=\"ansi-green-fg ansi-bold\">    483</span> )\n<span class=\"ansi-green-fg ansi-bold\">    484</span> factory <span style=\"color:rgb(98,98,98)\">=</span> FileSystemDatasetFactory(fs, paths_or_selector, <span style=\"color:rgb(0,135,0)\">format</span>, options)\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyarrow/dataset.py:441</span>, in <span class=\"ansi-cyan-fg\">_ensure_single_source</span><span class=\"ansi-blue-fg\">(path, filesystem)</span>\n<span class=\"ansi-green-fg ansi-bold\">    439</span>     paths_or_selector <span style=\"color:rgb(98,98,98)\">=</span> [path]\n<span class=\"ansi-green-fg ansi-bold\">    440</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">else</span>:\n<span class=\"ansi-green-fg\">--&gt; 441</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span> <span style=\"font-weight:bold;color:rgb(215,95,95)\">FileNotFoundError</span>(path)\n<span class=\"ansi-green-fg ansi-bold\">    443</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> filesystem, paths_or_selector\n\n<span class=\"ansi-red-fg\">FileNotFoundError</span>: data/webdata.parquet</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#a9ce37f1 .cell execution_count=9}\n``` {.python .cell-code}\ndfa.num_columns\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[8], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">dfa</span><span style=\"color:rgb(98,98,98)\">.</span>num_columns\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'dfa' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {.callout-warning}\n\nLet us go back to the spark data frame\n\n:::\n\n::: {#9dd2f0ec .cell ExecuteTime='{\"end_time\":\"2020-05-03T16:27:52.121782Z\",\"start_time\":\"2020-05-03T16:27:50.752210Z\"}' execution_count=10}\n``` {.python .cell-code}\ndf.head(6)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[9], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>head(<span style=\"color:rgb(98,98,98)\">6</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#0719e8ef .cell execution_count=11}\n``` {.python .cell-code}\ndf.show(5)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[10], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>show(<span style=\"color:rgb(98,98,98)\">5</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#c04e7d64 .cell execution_count=12}\n``` {.python .cell-code}\ndf.describe()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[11], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>describe()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#57384d37 .cell execution_count=13}\n``` {.python .cell-code}\ndf.printSchema()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[12], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>printSchema()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#40e0635a .cell execution_count=14}\n``` {.python .cell-code}\ndf.rdd.getNumPartitions()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[13], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>rdd<span style=\"color:rgb(98,98,98)\">.</span>getNumPartitions()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {.callout-note  title=\"Question\"}\n\nExplain the partition size. \n\n:::\n\n# Basic statistics\n\nFirst we need to import some things:\n\n- `Window` class\n- SQL functions module\n- Some very useful functions\n- Spark types\n\n::: {#ac302dce .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:20:34.024704Z\",\"start_time\":\"2020-05-03T15:20:34.016322Z\"}' execution_count=15}\n``` {.python .cell-code}\nfrom pyspark.sql import Window\nimport pyspark.sql.functions as func\nfrom pyspark.sql.types import *\nfrom pyspark.sql.functions import col, lit\n```\n:::\n\n\n## Compute the total number of unique users\n\n::: {#d6aa7f91 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:20:36.790893Z\",\"start_time\":\"2020-05-03T15:20:34.856924Z\"}' execution_count=16}\n``` {.python .cell-code}\n( \n    df.select('xid')\n      .distinct()\n      .count()\n)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[15], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> ( \n<span class=\"ansi-green-fg\">----&gt; 2</span>     <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>select(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">xid</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      3</span>       <span style=\"color:rgb(98,98,98)\">.</span>distinct()\n<span class=\"ansi-green-fg ansi-bold\">      4</span>       <span style=\"color:rgb(98,98,98)\">.</span>count()\n<span class=\"ansi-green-fg ansi-bold\">      5</span> )\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#76f28e53 .cell execution_count=17}\n``` {.python .cell-code}\ndef foo(x):\n   c = len(set(x))\n   print(c)\n   return c\n```\n:::\n\n\n::: {#b911acf7 .cell execution_count=18}\n``` {.python .cell-code}\nfoo([1, 1, 2])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n2\n```\n:::\n\n::: {.cell-output .cell-output-display execution_count=17}\n```\n2\n```\n:::\n:::\n\n\n::: {#84f13b1b .cell execution_count=19}\n``` {.python .cell-code}\ndf.rdd.map(lambda x : x.xid).foreachPartition(foo)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[18], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>rdd<span style=\"color:rgb(98,98,98)\">.</span>map(<span style=\"font-weight:bold;color:rgb(0,135,0)\">lambda</span> x : x<span style=\"color:rgb(98,98,98)\">.</span>xid)<span style=\"color:rgb(98,98,98)\">.</span>foreachPartition(foo)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#7940813c .cell execution_count=20}\n``` {.python .cell-code}\n78120 + 78636 + 79090 + 78865 + 79296 + 79754\n```\n\n::: {.cell-output .cell-output-display execution_count=19}\n```\n473761\n```\n:::\n:::\n\n\nThis might pump up some computational resources \n\n::: {#d1f23b99 .cell execution_count=21}\n``` {.python .cell-code}\n( \n    df.select('xid')\n      .distinct() \n      .explain()\n)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[20], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> ( \n<span class=\"ansi-green-fg\">----&gt; 2</span>     <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>select(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">xid</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      3</span>       <span style=\"color:rgb(98,98,98)\">.</span>distinct() \n<span class=\"ansi-green-fg ansi-bold\">      4</span>       <span style=\"color:rgb(98,98,98)\">.</span>explain()\n<span class=\"ansi-green-fg ansi-bold\">      5</span> )\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {.callout-note}\n\nThe distinct values of `xid` seem to be evenly spread among the six files making the `parquet` directory \n\n:::\n\n## Construct a column containing the total number of actions per user\n\n::: {#07c0e186 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:20:52.163321Z\",\"start_time\":\"2020-05-03T15:20:50.965856Z\"}' execution_count=22}\n``` {.python .cell-code}\nxid_partition = Window.partitionBy('xid')\n\nn_events = func.count(col('action')).over(xid_partition)\n\ndf = df.withColumn('n_events', n_events)\n\ndf.show(n=2)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[21], line 5</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> xid_partition <span style=\"color:rgb(98,98,98)\">=</span> Window<span style=\"color:rgb(98,98,98)\">.</span>partitionBy(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">xid</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      3</span> n_events <span style=\"color:rgb(98,98,98)\">=</span> func<span style=\"color:rgb(98,98,98)\">.</span>count(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">action</span><span style=\"color:rgb(175,0,0)\">'</span>))<span style=\"color:rgb(98,98,98)\">.</span>over(xid_partition)\n<span class=\"ansi-green-fg\">----&gt; 5</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_events</span><span style=\"color:rgb(175,0,0)\">'</span>, n_events)\n<span class=\"ansi-green-fg ansi-bold\">      7</span> df<span style=\"color:rgb(98,98,98)\">.</span>show(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#cf3d4168 .cell execution_count=23}\n``` {.python .cell-code}\n( \n  df\n    .groupBy('xid')\n    .agg(func.count('action'))\n    .show(n=5)\n)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[22], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> ( \n<span class=\"ansi-green-fg\">----&gt; 2</span>   <span class=\"ansi-yellow-bg\">df</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     <span style=\"color:rgb(98,98,98)\">.</span>groupBy(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">xid</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     <span style=\"color:rgb(98,98,98)\">.</span>agg(func<span style=\"color:rgb(98,98,98)\">.</span>count(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">action</span><span style=\"color:rgb(175,0,0)\">'</span>))\n<span class=\"ansi-green-fg ansi-bold\">      5</span>     <span style=\"color:rgb(98,98,98)\">.</span>show(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">5</span>)\n<span class=\"ansi-green-fg ansi-bold\">      6</span> )\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\nVisualize the distribution of the number of users per number of actions.\n\n::: {.callout-note title=\"Question\"}\n\nConstruct a column containing the number of days since the last action of the user\n\n:::\n\n::: {#b054b554 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:20:55.895918Z\",\"start_time\":\"2020-05-03T15:20:54.925126Z\"}' execution_count=24}\n``` {.python .cell-code}\n# xid_partition = Window.partitionBy('xid')\n\nmax_date = (\n  func\n    .max(col('date'))\n    .over(xid_partition)\n)\n\nn_days_since_last_event = func.datediff(func.current_date(), max_date)\n\ndf = df.withColumn('n_days_since_last_event',\n                   n_days_since_last_event)\n\ndf.show(n=2)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[23], line 11</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> max_date <span style=\"color:rgb(98,98,98)\">=</span> (\n<span class=\"ansi-green-fg ansi-bold\">      4</span>   func\n<span class=\"ansi-green-fg ansi-bold\">      5</span>     <span style=\"color:rgb(98,98,98)\">.</span>max(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">date</span><span style=\"color:rgb(175,0,0)\">'</span>))\n<span class=\"ansi-green-fg ansi-bold\">      6</span>     <span style=\"color:rgb(98,98,98)\">.</span>over(xid_partition)\n<span class=\"ansi-green-fg ansi-bold\">      7</span> )\n<span class=\"ansi-green-fg ansi-bold\">      9</span> n_days_since_last_event <span style=\"color:rgb(98,98,98)\">=</span> func<span style=\"color:rgb(98,98,98)\">.</span>datediff(func<span style=\"color:rgb(98,98,98)\">.</span>current_date(), max_date)\n<span class=\"ansi-green-fg\">---&gt; 11</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_days_since_last_event</span><span style=\"color:rgb(175,0,0)\">'</span>,\n<span class=\"ansi-green-fg ansi-bold\">     12</span>                    n_days_since_last_event)\n<span class=\"ansi-green-fg ansi-bold\">     14</span> df<span style=\"color:rgb(98,98,98)\">.</span>show(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#aecac298 .cell execution_count=25}\n``` {.python .cell-code}\ndf.printSchema()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[24], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>printSchema()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n## Construct a column containing the number of actions of each user for each modality of device\n\n::: {#0850a9bf .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:21:03.846417Z\",\"start_time\":\"2020-05-03T15:21:03.027855Z\"}' execution_count=26}\n``` {.python .cell-code}\nxid_device_partition = xid_partition.partitionBy('device')\n\nn_events_per_device = func.count(col('action')).over(xid_device_partition)\n\ndf = df.withColumn('n_events_per_device', n_events_per_device)\n\ndf.head(n=2)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[25], line 5</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> xid_device_partition <span style=\"color:rgb(98,98,98)\">=</span> xid_partition<span style=\"color:rgb(98,98,98)\">.</span>partitionBy(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">device</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      3</span> n_events_per_device <span style=\"color:rgb(98,98,98)\">=</span> func<span style=\"color:rgb(98,98,98)\">.</span>count(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">action</span><span style=\"color:rgb(175,0,0)\">'</span>))<span style=\"color:rgb(98,98,98)\">.</span>over(xid_device_partition)\n<span class=\"ansi-green-fg\">----&gt; 5</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_events_per_device</span><span style=\"color:rgb(175,0,0)\">'</span>, n_events_per_device)\n<span class=\"ansi-green-fg ansi-bold\">      7</span> df<span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n## Number of devices per user {{< fa mug-hot >}}\n\n::: {#3fbc1912 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:21:06.411472Z\",\"start_time\":\"2020-05-03T15:21:05.373879Z\"}' execution_count=27}\n``` {.python .cell-code}\nxid_partition = Window.partitionBy('xid')\n\nrank_device = (\n  func\n    .dense_rank()\n    .over(xid_partition.orderBy('device'))\n)\n\nn_unique_device = (\n    func\n      .last(rank_device)\n      .over(xid_partition)\n)\n\ndf = df.withColumn('n_device', n_unique_device)\n\ndf.head(n=2)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[26], line 15</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> rank_device <span style=\"color:rgb(98,98,98)\">=</span> (\n<span class=\"ansi-green-fg ansi-bold\">      4</span>   func\n<span class=\"ansi-green-fg ansi-bold\">      5</span>     <span style=\"color:rgb(98,98,98)\">.</span>dense_rank()\n<span class=\"ansi-green-fg ansi-bold\">      6</span>     <span style=\"color:rgb(98,98,98)\">.</span>over(xid_partition<span style=\"color:rgb(98,98,98)\">.</span>orderBy(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">device</span><span style=\"color:rgb(175,0,0)\">'</span>))\n<span class=\"ansi-green-fg ansi-bold\">      7</span> )\n<span class=\"ansi-green-fg ansi-bold\">      9</span> n_unique_device <span style=\"color:rgb(98,98,98)\">=</span> (\n<span class=\"ansi-green-fg ansi-bold\">     10</span>     func\n<span class=\"ansi-green-fg ansi-bold\">     11</span>       <span style=\"color:rgb(98,98,98)\">.</span>last(rank_device)\n<span class=\"ansi-green-fg ansi-bold\">     12</span>       <span style=\"color:rgb(98,98,98)\">.</span>over(xid_partition)\n<span class=\"ansi-green-fg ansi-bold\">     13</span> )\n<span class=\"ansi-green-fg\">---&gt; 15</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_device</span><span style=\"color:rgb(175,0,0)\">'</span>, n_unique_device)\n<span class=\"ansi-green-fg ansi-bold\">     17</span> df<span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#2f378d61 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:21:13.863382Z\",\"start_time\":\"2020-05-03T15:21:12.479688Z\"}' execution_count=28}\n``` {.python .cell-code}\ndf\\\n    .where(col('n_device') > 1)\\\n    .select('xid', 'device', 'n_events',  'n_device', 'n_events_per_device')\\\n    .head(n=8)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[27], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span>\\\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     <span style=\"color:rgb(98,98,98)\">.</span>where(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_device</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">&gt;</span> <span style=\"color:rgb(98,98,98)\">1</span>)\\\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     <span style=\"color:rgb(98,98,98)\">.</span>select(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">xid</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">device</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_events</span><span style=\"color:rgb(175,0,0)\">'</span>,  <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_device</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_events_per_device</span><span style=\"color:rgb(175,0,0)\">'</span>)\\\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     <span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">8</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#e01a3c6b .cell execution_count=29}\n``` {.python .cell-code}\ndf\\\n    .where(col('n_device') > 1)\\\n    .select('xid', 'device', 'n_events',  'n_device', 'n_events_per_device')\\\n    .count()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[28], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span>\\\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     <span style=\"color:rgb(98,98,98)\">.</span>where(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_device</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">&gt;</span> <span style=\"color:rgb(98,98,98)\">1</span>)\\\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     <span style=\"color:rgb(98,98,98)\">.</span>select(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">xid</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">device</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_events</span><span style=\"color:rgb(175,0,0)\">'</span>,  <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_device</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_events_per_device</span><span style=\"color:rgb(175,0,0)\">'</span>)\\\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     <span style=\"color:rgb(98,98,98)\">.</span>count()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n# Let's select the correct users and build a training dataset\n\nWe construct a ETL (Extract Transform Load) process on this data using the `pyspark.sql` API.\n\n## Extraction\n\nHere extraction is just about reading the data\n\n::: {#3299f43b .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:21:36.683625Z\",\"start_time\":\"2020-05-03T15:21:36.427615Z\"}' execution_count=30}\n``` {.python .cell-code}\ndf = spark.read.parquet(file_path)\ndf.show(n=3)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">AnalysisException</span>                         Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[29], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">spark</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">read</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">parquet</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">file_path</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> df<span style=\"color:rgb(98,98,98)\">.</span>show(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">3</span>)\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyspark/sql/readwriter.py:544</span>, in <span class=\"ansi-cyan-fg\">DataFrameReader.parquet</span><span class=\"ansi-blue-fg\">(self, *paths, **options)</span>\n<span class=\"ansi-green-fg ansi-bold\">    533</span> int96RebaseMode <span style=\"color:rgb(98,98,98)\">=</span> options<span style=\"color:rgb(98,98,98)\">.</span>get(<span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">int96RebaseMode</span><span style=\"color:rgb(175,0,0)\">\"</span>, <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>)\n<span class=\"ansi-green-fg ansi-bold\">    534</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_set_opts(\n<span class=\"ansi-green-fg ansi-bold\">    535</span>     mergeSchema<span style=\"color:rgb(98,98,98)\">=</span>mergeSchema,\n<span class=\"ansi-green-fg ansi-bold\">    536</span>     pathGlobFilter<span style=\"color:rgb(98,98,98)\">=</span>pathGlobFilter,\n<span class=\"ansi-green-fg\">   (...)</span>\n<span class=\"ansi-green-fg ansi-bold\">    541</span>     int96RebaseMode<span style=\"color:rgb(98,98,98)\">=</span>int96RebaseMode,\n<span class=\"ansi-green-fg ansi-bold\">    542</span> )\n<span class=\"ansi-green-fg\">--&gt; 544</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_df(<span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_jreader</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">parquet</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">_to_seq</span><span class=\"ansi-yellow-bg\">(</span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_spark</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_sc</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span class=\"ansi-yellow-bg\">paths</span><span class=\"ansi-yellow-bg\">)</span><span class=\"ansi-yellow-bg\">)</span>)\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/py4j/java_gateway.py:1322</span>, in <span class=\"ansi-cyan-fg\">JavaMember.__call__</span><span class=\"ansi-blue-fg\">(self, *args)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1316</span> command <span style=\"color:rgb(98,98,98)\">=</span> proto<span style=\"color:rgb(98,98,98)\">.</span>CALL_COMMAND_NAME <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1317</span>     <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>command_header <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1318</span>     args_command <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1319</span>     proto<span style=\"color:rgb(98,98,98)\">.</span>END_COMMAND_PART\n<span class=\"ansi-green-fg ansi-bold\">   1321</span> answer <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>gateway_client<span style=\"color:rgb(98,98,98)\">.</span>send_command(command)\n<span class=\"ansi-green-fg\">-&gt; 1322</span> return_value <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">get_return_value</span><span class=\"ansi-yellow-bg\">(</span>\n<span class=\"ansi-green-fg ansi-bold\">   1323</span> <span class=\"ansi-yellow-bg\">    </span><span class=\"ansi-yellow-bg\">answer</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">gateway_client</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">target_id</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">name</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1325</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> temp_arg <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> temp_args:\n<span class=\"ansi-green-fg ansi-bold\">   1326</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">hasattr</span>(temp_arg, <span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">_detach</span><span style=\"color:rgb(175,0,0)\">\"</span>):\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyspark/errors/exceptions/captured.py:185</span>, in <span class=\"ansi-cyan-fg\">capture_sql_exception.&lt;locals&gt;.deco</span><span class=\"ansi-blue-fg\">(*a, **kw)</span>\n<span class=\"ansi-green-fg ansi-bold\">    181</span> converted <span style=\"color:rgb(98,98,98)\">=</span> convert_exception(e<span style=\"color:rgb(98,98,98)\">.</span>java_exception)\n<span class=\"ansi-green-fg ansi-bold\">    182</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"font-weight:bold;color:rgb(175,0,255)\">not</span> <span style=\"color:rgb(0,135,0)\">isinstance</span>(converted, UnknownException):\n<span class=\"ansi-green-fg ansi-bold\">    183</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># Hide where the exception came from that shows a non-Pythonic</span>\n<span class=\"ansi-green-fg ansi-bold\">    184</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># JVM exception message.</span>\n<span class=\"ansi-green-fg\">--&gt; 185</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span> converted <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>\n<span class=\"ansi-green-fg ansi-bold\">    186</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">else</span>:\n<span class=\"ansi-green-fg ansi-bold\">    187</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span>\n\n<span class=\"ansi-red-fg\">AnalysisException</span>: [PATH_NOT_FOUND] Path does not exist: file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/webdata.parquet.</pre>\n```\n:::\n\n:::\n:::\n\n\n## Transformation of the data\n\nAt this step we compute a lot of extra things from the data. The aim is to build *features* that describe users.\n\n::: {#12edbcb2 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:24:09.159215Z\",\"start_time\":\"2020-05-03T15:24:09.136189Z\"}' execution_count=31}\n``` {.python .cell-code}\ndef n_events_transformer(df):\n    xid_partition = Window.partitionBy('xid')\n    n_events = func.count(col('action')).over(xid_partition)\n    \n    df = df.withColumn('n_events', n_events)\n\n    return df\n```\n:::\n\n\n::: {#92727914 .cell execution_count=32}\n``` {.python .cell-code}\ndef n_events_per_action_transformer(df):\n    xid_action_partition = Window.partitionBy('xid', 'action')\n    n_events_per_action = func.count(col('action')).over(xid_action_partition)\n\n    df = df.withColumn('n_events_per_action', n_events_per_action)\n    \n    return df\n```\n:::\n\n\n::: {#143f13b1 .cell execution_count=33}\n``` {.python .cell-code}\ndef hour_transformer(df):\n    hour = func.hour(col('date'))\n    df = df.withColumn('hour', hour)\n    return df\n\ndef weekday_transformer(df):\n    weekday = func.date_format(col('date'), 'EEEE')\n    df = df.withColumn('weekday', weekday)\n    return df\n\ndef n_events_per_hour_transformer(df):\n    xid_hour_partition = Window.partitionBy('xid', 'hour')\n    n_events_per_hour = func.count(col('action')).over(xid_hour_partition)\n    df = df.withColumn('n_events_per_hour', n_events_per_hour)\n    return df\n\ndef n_events_per_weekday_transformer(df):\n    xid_weekday_partition = Window.partitionBy('xid', 'weekday')\n    n_events_per_weekday = func.count(col('action')).over(xid_weekday_partition)\n    df = df.withColumn('n_events_per_weekday', n_events_per_weekday)\n    return df\n\ndef n_days_since_last_event_transformer(df):\n    xid_partition = Window.partitionBy('xid')\n    max_date = func.max(col('date')).over(xid_partition)\n    n_days_since_last_event = func.datediff(func.current_date(), max_date)\n    df = df.withColumn('n_days_since_last_event',\n                       n_days_since_last_event + lit(0.1))\n    return df\n\ndef n_days_since_last_action_transformer(df):\n    xid_partition_action = Window.partitionBy('xid', 'action')\n    max_date = func.max(col('date')).over(xid_partition_action)\n    n_days_since_last_action = func.datediff(func.current_date(),\n                                                        max_date)\n    df = df.withColumn('n_days_since_last_action',\n                       n_days_since_last_action + lit(0.1))\n    return df\n\ndef n_unique_day_transformer(df):\n    xid_partition = Window.partitionBy('xid')\n    dayofyear = func.dayofyear(col('date'))\n    rank_day = func.dense_rank().over(xid_partition.orderBy(dayofyear))\n    n_unique_day = func.last(rank_day).over(xid_partition)\n    df = df.withColumn('n_unique_day', n_unique_day)\n    return df\n\ndef n_unique_hour_transformer(df):\n    xid_partition = Window.partitionBy('xid')\n    rank_hour = func.dense_rank().over(xid_partition.orderBy('hour'))\n    n_unique_hour = func.last(rank_hour).over(xid_partition)\n    df = df.withColumn('n_unique_hour', n_unique_hour)\n    return df\n\ndef n_events_per_device_transformer(df):\n    xid_device_partition = Window.partitionBy('xid', 'device')\n    n_events_per_device = func.count(func.col('device')) \\\n        .over(xid_device_partition)\n    df = df.withColumn('n_events_per_device', n_events_per_device)\n    return df\n\ndef n_unique_device_transformer(df):\n    xid_partition = Window.partitionBy('xid')\n    rank_device = func.dense_rank().over(xid_partition.orderBy('device'))\n    n_unique_device = func.last(rank_device).over(xid_partition)\n    df = df.withColumn('n_device', n_unique_device)\n    return df\n\ndef n_actions_per_category_id_transformer(df):\n    xid_category_id_partition = Window.partitionBy('xid', 'category_id',\n                                                   'action')\n    n_actions_per_category_id = func.count(func.col('action')) \\\n        .over(xid_category_id_partition)\n    df = df.withColumn('n_actions_per_category_id', n_actions_per_category_id)\n    return df\n\ndef n_unique_category_id_transformer(df):\n    xid_partition = Window.partitionBy('xid')\n    rank_category_id = func.dense_rank().over(xid_partition\\\n                                              .orderBy('category_id'))\n    n_unique_category_id = func.last(rank_category_id).over(xid_partition)\n    df = df.withColumn('n_unique_category_id', n_unique_category_id)\n    return df\n\ndef n_events_per_category_id_transformer(df):\n    xid_category_id_partition = Window.partitionBy('xid', 'category_id')\n    n_events_per_category_id = func.count(func.col('action')) \\\n        .over(xid_category_id_partition)\n    df = df.withColumn('n_events_per_category_id', n_events_per_category_id)\n    return df\n\ndef n_events_per_website_id_transformer(df):\n    xid_website_id_partition = Window.partitionBy('xid', 'website_id')\n    n_events_per_website_id = func.count(col('action'))\\\n        .over(xid_website_id_partition)\n    df = df.withColumn('n_events_per_website_id', n_events_per_website_id)\n    return df\n```\n:::\n\n\n::: {#d1a75271 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:24:33.042444Z\",\"start_time\":\"2020-05-03T15:24:15.032735Z\"}' execution_count=34}\n``` {.python .cell-code}\ntransformers = [\n    hour_transformer,\n    weekday_transformer,\n    n_events_per_hour_transformer,\n    n_events_per_weekday_transformer,\n    n_days_since_last_event_transformer,\n    n_days_since_last_action_transformer,\n    n_unique_day_transformer,\n    n_unique_hour_transformer,\n    n_events_per_device_transformer,\n    n_unique_device_transformer,\n    n_actions_per_category_id_transformer,\n    n_events_per_category_id_transformer,\n    n_events_per_website_id_transformer,\n]\n```\n:::\n\n\n::: {#f3977365 .cell execution_count=35}\n``` {.python .cell-code}\nN = 10000\n```\n:::\n\n\n::: {#de6e63fd .cell execution_count=36}\n``` {.python .cell-code}\nsample_df = df.sample(withReplacement=False, fraction=.05)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[35], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> sample_df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>sample(withReplacement<span style=\"color:rgb(98,98,98)\">=</span><span style=\"font-weight:bold;color:rgb(0,135,0)\">False</span>, fraction<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">.05</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#6267445c .cell execution_count=37}\n``` {.python .cell-code}\nsample_df.count()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[36], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">sample_df</span><span style=\"color:rgb(98,98,98)\">.</span>count()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'sample_df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#a6558a56 .cell execution_count=38}\n``` {.python .cell-code}\nfor transformer in transformers:\n    df = transformer(df)\n\ndf.head(n=1)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[37], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> transformer <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> transformers:\n<span class=\"ansi-green-fg\">----&gt; 2</span>     df <span style=\"color:rgb(98,98,98)\">=</span> transformer(<span class=\"ansi-yellow-bg\">df</span>)\n<span class=\"ansi-green-fg ansi-bold\">      4</span> df<span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#858b78ed .cell execution_count=39}\n``` {.python .cell-code}\nfor transformer in transformers:\n    sample_df = transformer(sample_df)\n\nsample_df.head(n=1)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[38], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> transformer <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> transformers:\n<span class=\"ansi-green-fg\">----&gt; 2</span>     sample_df <span style=\"color:rgb(98,98,98)\">=</span> transformer(<span class=\"ansi-yellow-bg\">sample_df</span>)\n<span class=\"ansi-green-fg ansi-bold\">      4</span> sample_df<span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'sample_df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#c8f095b5 .cell execution_count=40}\n``` {.python .cell-code}\ndf = sample_df\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[39], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">sample_df</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'sample_df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#23c9d959 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:24:40.406910Z\",\"start_time\":\"2020-05-03T15:24:40.393184Z\"}' execution_count=41}\n``` {.python .cell-code}\nsorted(df.columns)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[40], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"color:rgb(0,135,0)\">sorted</span>(<span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>columns)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n## Load step\n\nHere, we use all the previous computations (saved in the columns of the dataframe) \nto compute aggregated informations about each user.\n\n::: {#53e23270 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:25:22.243433Z\",\"start_time\":\"2020-05-03T15:25:22.217248Z\"}' execution_count=42}\n``` {.python .cell-code}\ndef n_events_per_hour_loader(df):\n    csr = df\\\n        .select('xid', 'hour', 'n_events_per_hour')\\\n        .withColumnRenamed('n_events_per_hour', 'value')\\\n        .distinct()     # action\n    feature_name = func.concat(lit('n_events_per_hour#'), col('hour'))\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('hour')\n    return csr\n\ndef n_events_per_website_id_loader(df):\n    csr = df.select('xid', 'website_id', 'n_events_per_website_id')\\\n        .withColumnRenamed('n_events_per_hour', 'value')\\\n        .distinct()\n    feature_name = func.concat(lit('n_events_per_website_id#'),\n                               col('website_id'))\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('website_id')\n    return csr\n\ndef n_events_per_hour_loader(df):\n    csr = df\\\n        .select('xid', 'hour', 'n_events_per_hour')\\\n        .withColumnRenamed('n_events_per_hour', 'value')\\\n        .distinct()\n    feature_name = func.concat(lit('n_events_per_hour#'), col('hour'))\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('hour')\n    return csr\n\ndef n_events_per_weekday_loader(df):\n    csr = df\\\n        .select('xid', 'weekday', 'n_events_per_weekday')\\\n        .withColumnRenamed('n_events_per_weekday', 'value')\\\n        .distinct()\n    feature_name = func.concat(lit('n_events_per_weekday#'), col('weekday'))\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('weekday')\n    return csr\n\ndef n_days_since_last_event_loader(df):\n    csr = df.select('xid',  'n_days_since_last_event')\\\n        .withColumnRenamed('n_days_since_last_event#', 'value')\\\n        .distinct()\n    feature_name = lit('n_days_since_last_event')\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\n    return csr\n\ndef n_days_since_last_action_loader(df):\n    csr = df.select('xid', 'action', 'n_days_since_last_action')\\\n        .withColumnRenamed('n_days_since_last_action', 'value')\\\n        .distinct()\n    feature_name = func.concat(lit('n_days_since_last_action#'), col('action'))\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('action')\n    return csr\n\ndef n_unique_day_loader(df):\n    csr = df.select('xid', 'n_unique_day')\\\n        .withColumnRenamed('n_unique_day', 'value')\\\n        .distinct()\n    feature_name = lit('n_unique_day')\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\n    return csr\n\ndef n_unique_hour_loader(df):\n    csr = df.select('xid', 'n_unique_hour')\\\n        .withColumnRenamed('n_unique_hour', 'value')\\\n        .distinct()\n    feature_name = lit('n_unique_hour')\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\n    return csr\n\ndef n_events_per_device_loader(df):\n    csr = df\\\n        .select('xid', 'device', 'n_events_per_device')\\\n        .withColumnRenamed('n_events_per_device', 'value')\\\n        .distinct()\n    feature_name = func.concat(lit('n_events_per_device#'), col('device'))\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('device')\n    return csr\n\ndef n_unique_device_loader(df):\n    csr = df.select('xid', 'n_device')\\\n        .withColumnRenamed('n_device', 'value')\\\n        .distinct()\n    feature_name = lit('n_device')\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\n    return csr\n\ndef n_events_per_category_id_loader(df):\n    csr = df.select('xid', 'category_id', 'n_events_per_category_id')\\\n        .withColumnRenamed('n_events_per_category_id', 'value')\\\n        .distinct()\n    feature_name = func.concat(lit('n_events_per_category_id#'),\n                               col('category_id'))\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('category_id')\n    return csr\n\ndef n_actions_per_category_id_loader(df):\n    csr = df.select('xid', 'category_id', 'action', 'n_actions_per_category_id')\\\n        .withColumnRenamed('n_actions_per_category_id', 'value')\\\n        .distinct()\n    feature_name = func.concat(lit('n_actions_per_category_id#'),\n                               col('action'), lit('#'), \n                               col('category_id'))\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('category_id')\\\n        .drop('action')\n    return csr\n\ndef n_events_per_website_id_loader(df):\n    csr = df.select('xid', 'website_id', 'n_events_per_website_id')\\\n        .withColumnRenamed('n_events_per_website_id', 'value')\\\n        .distinct()\n    feature_name = func.concat(lit('n_events_per_website_id#'),\n                               col('website_id'))\n    csr = csr\\\n        .withColumn('feature_name', feature_name)\\\n        .drop('website_id')\n    return csr\n```\n:::\n\n\n::: {#7e4944b0 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:25:48.149670Z\",\"start_time\":\"2020-05-03T15:25:37.966657Z\"}' execution_count=43}\n``` {.python .cell-code}\nfrom functools import reduce\n```\n:::\n\n\n::: {#b80d53c9 .cell execution_count=44}\n``` {.python .cell-code}\nloaders = [\n    n_events_per_hour_loader,\n    n_events_per_website_id_loader,\n    n_events_per_hour_loader,\n    n_events_per_weekday_loader,\n    n_days_since_last_event_loader,\n    n_days_since_last_action_loader,\n    n_unique_day_loader,\n    n_unique_hour_loader,\n    n_events_per_device_loader,\n    n_unique_device_loader,\n    n_events_per_category_id_loader,\n    n_actions_per_category_id_loader,\n    n_events_per_website_id_loader,\n]\n```\n:::\n\n\n::: {#b2087036 .cell execution_count=45}\n``` {.python .cell-code}\ndef union(df, other):\n    return df.union(other)\n```\n:::\n\n\n::: {.callout-caution title=\"About DataFrame.union()\"}\n\nThis method performs a SQL-style set union of the rows from both DataFrame objects, with no automatic deduplication of elements.\n\nUse the distinct() method to perform deduplication of rows.\n\nThe method resolves columns by position (not by name), following the standard behavior in SQL.\n\n:::\n\n::: {#a716cd8b .cell execution_count=46}\n``` {.python .cell-code}\nspam = [loader(df) for loader in loaders]\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[45], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> spam <span style=\"color:rgb(98,98,98)\">=</span> [loader(<span class=\"ansi-yellow-bg\">df</span>) <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> loader <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> loaders]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#1f582523 .cell execution_count=47}\n``` {.python .cell-code}\nspam[0].printSchema()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[46], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">spam</span>[<span style=\"color:rgb(98,98,98)\">0</span>]<span style=\"color:rgb(98,98,98)\">.</span>printSchema()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'spam' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#1206a631 .cell execution_count=48}\n``` {.python .cell-code}\nlen(spam)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[47], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"color:rgb(0,135,0)\">len</span>(<span class=\"ansi-yellow-bg\">spam</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'spam' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#14533120 .cell execution_count=49}\n``` {.python .cell-code}\ncsr = reduce(\n    lambda df1, df2: df1.union(df2),\n    spam\n)\n\ncsr.head(n=3)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[48], line 3</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> csr <span style=\"color:rgb(98,98,98)\">=</span> reduce(\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">lambda</span> df1, df2: df1<span style=\"color:rgb(98,98,98)\">.</span>union(df2),\n<span class=\"ansi-green-fg\">----&gt; 3</span>     <span class=\"ansi-yellow-bg\">spam</span>\n<span class=\"ansi-green-fg ansi-bold\">      4</span> )\n<span class=\"ansi-green-fg ansi-bold\">      6</span> csr<span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">3</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'spam' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#e919bde5 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:25:54.862814Z\",\"start_time\":\"2020-05-03T15:25:54.857914Z\"}' execution_count=50}\n``` {.python .cell-code}\ncsr.columns\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[49], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">csr</span><span style=\"color:rgb(98,98,98)\">.</span>columns\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#0ff41f64 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:26:13.629146Z\",\"start_time\":\"2020-05-03T15:25:55.683800Z\"}' execution_count=51}\n``` {.python .cell-code}\ncsr.show(5)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[50], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">csr</span><span style=\"color:rgb(98,98,98)\">.</span>show(<span style=\"color:rgb(98,98,98)\">5</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#85653d50 .cell execution_count=52}\n``` {.python .cell-code}\ncsr.rdd.getNumPartitions()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[51], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">csr</span><span style=\"color:rgb(98,98,98)\">.</span>rdd<span style=\"color:rgb(98,98,98)\">.</span>getNumPartitions()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#d0288de6 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:30:20.643141Z\",\"start_time\":\"2020-05-03T15:29:45.221790Z\"}' execution_count=53}\n``` {.python .cell-code}\n# Replace features names and xid by a unique number\nfeature_name_partition = Window().orderBy('feature_name')\nxid_partition = Window().orderBy('xid')\n\ncol_idx = func.dense_rank().over(feature_name_partition)\nrow_idx = func.dense_rank().over(xid_partition)\n```\n:::\n\n\n::: {#361807ef .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:30:20.643141Z\",\"start_time\":\"2020-05-03T15:29:45.221790Z\"}' execution_count=54}\n``` {.python .cell-code}\ncsr = csr.withColumn('col', col_idx)\\\n    .withColumn('row', row_idx)\n\ncsr = csr.na.drop('any')\n\ncsr.head(n=5)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[53], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> csr <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">csr</span><span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">col</span><span style=\"color:rgb(175,0,0)\">'</span>, col_idx)\\\n<span class=\"ansi-green-fg ansi-bold\">      2</span>     <span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">row</span><span style=\"color:rgb(175,0,0)\">'</span>, row_idx)\n<span class=\"ansi-green-fg ansi-bold\">      4</span> csr <span style=\"color:rgb(98,98,98)\">=</span> csr<span style=\"color:rgb(98,98,98)\">.</span>na<span style=\"color:rgb(98,98,98)\">.</span>drop(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">any</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      6</span> csr<span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">5</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#488b66ab .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:32:02.552364Z\",\"start_time\":\"2020-05-03T15:31:14.990298Z\"}' execution_count=55}\n``` {.python .cell-code}\n# Let's save the result of our hard work into a new parquet file\noutput_path = Path('./data')\noutput_file = str(output_path / 'csr.parquet')\ncsr.write.parquet(output_file, mode='overwrite')\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[54], line 4</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> output_path <span style=\"color:rgb(98,98,98)\">=</span> Path(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">./data</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      3</span> output_file <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">str</span>(output_path <span style=\"color:rgb(98,98,98)\">/</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">csr.parquet</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg\">----&gt; 4</span> <span class=\"ansi-yellow-bg\">csr</span><span style=\"color:rgb(98,98,98)\">.</span>write<span style=\"color:rgb(98,98,98)\">.</span>parquet(output_file, mode<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">overwrite</span><span style=\"color:rgb(175,0,0)\">'</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n# Preparation of the training dataset\n\n::: {#618e47ec .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:32:56.421452Z\",\"start_time\":\"2020-05-03T15:32:55.819071Z\"}' execution_count=56}\n``` {.python .cell-code}\ncsr_path = './data'\ncsr_file = os.path.join(csr_path, 'csr.parquet')\n\ndf = spark.read.parquet(csr_file)\ndf.head(n=5)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">AnalysisException</span>                         Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[55], line 4</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> csr_path <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">./data</span><span style=\"color:rgb(175,0,0)\">'</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> csr_file <span style=\"color:rgb(98,98,98)\">=</span> os<span style=\"color:rgb(98,98,98)\">.</span>path<span style=\"color:rgb(98,98,98)\">.</span>join(csr_path, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">csr.parquet</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg\">----&gt; 4</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">spark</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">read</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">parquet</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">csr_file</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">      5</span> df<span style=\"color:rgb(98,98,98)\">.</span>head(n<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">5</span>)\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyspark/sql/readwriter.py:544</span>, in <span class=\"ansi-cyan-fg\">DataFrameReader.parquet</span><span class=\"ansi-blue-fg\">(self, *paths, **options)</span>\n<span class=\"ansi-green-fg ansi-bold\">    533</span> int96RebaseMode <span style=\"color:rgb(98,98,98)\">=</span> options<span style=\"color:rgb(98,98,98)\">.</span>get(<span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">int96RebaseMode</span><span style=\"color:rgb(175,0,0)\">\"</span>, <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>)\n<span class=\"ansi-green-fg ansi-bold\">    534</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_set_opts(\n<span class=\"ansi-green-fg ansi-bold\">    535</span>     mergeSchema<span style=\"color:rgb(98,98,98)\">=</span>mergeSchema,\n<span class=\"ansi-green-fg ansi-bold\">    536</span>     pathGlobFilter<span style=\"color:rgb(98,98,98)\">=</span>pathGlobFilter,\n<span class=\"ansi-green-fg\">   (...)</span>\n<span class=\"ansi-green-fg ansi-bold\">    541</span>     int96RebaseMode<span style=\"color:rgb(98,98,98)\">=</span>int96RebaseMode,\n<span class=\"ansi-green-fg ansi-bold\">    542</span> )\n<span class=\"ansi-green-fg\">--&gt; 544</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_df(<span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_jreader</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">parquet</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">_to_seq</span><span class=\"ansi-yellow-bg\">(</span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_spark</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_sc</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span class=\"ansi-yellow-bg\">paths</span><span class=\"ansi-yellow-bg\">)</span><span class=\"ansi-yellow-bg\">)</span>)\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/py4j/java_gateway.py:1322</span>, in <span class=\"ansi-cyan-fg\">JavaMember.__call__</span><span class=\"ansi-blue-fg\">(self, *args)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1316</span> command <span style=\"color:rgb(98,98,98)\">=</span> proto<span style=\"color:rgb(98,98,98)\">.</span>CALL_COMMAND_NAME <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1317</span>     <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>command_header <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1318</span>     args_command <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1319</span>     proto<span style=\"color:rgb(98,98,98)\">.</span>END_COMMAND_PART\n<span class=\"ansi-green-fg ansi-bold\">   1321</span> answer <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>gateway_client<span style=\"color:rgb(98,98,98)\">.</span>send_command(command)\n<span class=\"ansi-green-fg\">-&gt; 1322</span> return_value <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">get_return_value</span><span class=\"ansi-yellow-bg\">(</span>\n<span class=\"ansi-green-fg ansi-bold\">   1323</span> <span class=\"ansi-yellow-bg\">    </span><span class=\"ansi-yellow-bg\">answer</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">gateway_client</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">target_id</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">name</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1325</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> temp_arg <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> temp_args:\n<span class=\"ansi-green-fg ansi-bold\">   1326</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">hasattr</span>(temp_arg, <span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">_detach</span><span style=\"color:rgb(175,0,0)\">\"</span>):\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyspark/errors/exceptions/captured.py:185</span>, in <span class=\"ansi-cyan-fg\">capture_sql_exception.&lt;locals&gt;.deco</span><span class=\"ansi-blue-fg\">(*a, **kw)</span>\n<span class=\"ansi-green-fg ansi-bold\">    181</span> converted <span style=\"color:rgb(98,98,98)\">=</span> convert_exception(e<span style=\"color:rgb(98,98,98)\">.</span>java_exception)\n<span class=\"ansi-green-fg ansi-bold\">    182</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"font-weight:bold;color:rgb(175,0,255)\">not</span> <span style=\"color:rgb(0,135,0)\">isinstance</span>(converted, UnknownException):\n<span class=\"ansi-green-fg ansi-bold\">    183</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># Hide where the exception came from that shows a non-Pythonic</span>\n<span class=\"ansi-green-fg ansi-bold\">    184</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># JVM exception message.</span>\n<span class=\"ansi-green-fg\">--&gt; 185</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span> converted <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>\n<span class=\"ansi-green-fg ansi-bold\">    186</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">else</span>:\n<span class=\"ansi-green-fg ansi-bold\">    187</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span>\n\n<span class=\"ansi-red-fg\">AnalysisException</span>: [PATH_NOT_FOUND] Path does not exist: file:/home/boucheron/Documents/IFEBY310/core/notebooks/data/csr.parquet.</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#f09a63a7 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:17.229477Z\",\"start_time\":\"2020-05-03T15:33:16.995048Z\"}' execution_count=57}\n``` {.python .cell-code}\ndf.count()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[56], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>count()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#fe14a705 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:20.881392Z\",\"start_time\":\"2020-05-03T15:33:19.624525Z\"}' execution_count=58}\n``` {.python .cell-code}\n# What are the features related to campaign_id 1204 ?\nfeatures_names = \\\n    df.select('feature_name')\\\n    .distinct()\\\n    .toPandas()['feature_name']\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[57], line 3</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># What are the features related to campaign_id 1204 ?</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> features_names <span style=\"color:rgb(98,98,98)\">=</span> \\\n<span class=\"ansi-green-fg\">----&gt; 3</span>     <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>select(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">feature_name</span><span style=\"color:rgb(175,0,0)\">'</span>)\\\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     <span style=\"color:rgb(98,98,98)\">.</span>distinct()\\\n<span class=\"ansi-green-fg ansi-bold\">      5</span>     <span style=\"color:rgb(98,98,98)\">.</span>toPandas()[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">feature_name</span><span style=\"color:rgb(175,0,0)\">'</span>]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#1e773739 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:21.818568Z\",\"start_time\":\"2020-05-03T15:33:21.812810Z\"}' execution_count=59}\n``` {.python .cell-code}\nfeatures_names\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[58], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">features_names</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'features_names' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#2b866894 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:27.083141Z\",\"start_time\":\"2020-05-03T15:33:27.078374Z\"}' execution_count=60}\n``` {.python .cell-code}\n[feature_name for feature_name in features_names if '1204' in feature_name]\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[59], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> [feature_name <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> feature_name <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> <span class=\"ansi-yellow-bg\">features_names</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">1204</span><span style=\"color:rgb(175,0,0)\">'</span> <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> feature_name]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'features_names' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#bc4d6bfd .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:28.560631Z\",\"start_time\":\"2020-05-03T15:33:27.903921Z\"}' execution_count=61}\n``` {.python .cell-code}\n# Look for the xid that have at least one exposure to campaign 1204\nkeep = func.when(\n    (col('feature_name') == 'n_actions_per_category_id#C#1204.0') |\n    (col('feature_name') == 'n_actions_per_category_id#O#1204.0'),\n    1).otherwise(0)\ndf = df.withColumn('keep', keep)\n\ndf.where(col('keep') > 0).count()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[60], line 6</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># Look for the xid that have at least one exposure to campaign 1204</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> keep <span style=\"color:rgb(98,98,98)\">=</span> func<span style=\"color:rgb(98,98,98)\">.</span>when(\n<span class=\"ansi-green-fg ansi-bold\">      3</span>     (col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">feature_name</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">==</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_actions_per_category_id#C#1204.0</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">|</span>\n<span class=\"ansi-green-fg ansi-bold\">      4</span>     (col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">feature_name</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">==</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_actions_per_category_id#O#1204.0</span><span style=\"color:rgb(175,0,0)\">'</span>),\n<span class=\"ansi-green-fg ansi-bold\">      5</span>     <span style=\"color:rgb(98,98,98)\">1</span>)<span style=\"color:rgb(98,98,98)\">.</span>otherwise(<span style=\"color:rgb(98,98,98)\">0</span>)\n<span class=\"ansi-green-fg\">----&gt; 6</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">keep</span><span style=\"color:rgb(175,0,0)\">'</span>, keep)\n<span class=\"ansi-green-fg ansi-bold\">      8</span> df<span style=\"color:rgb(98,98,98)\">.</span>where(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">keep</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">&gt;</span> <span style=\"color:rgb(98,98,98)\">0</span>)<span style=\"color:rgb(98,98,98)\">.</span>count()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#cffe13e3 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:31.274277Z\",\"start_time\":\"2020-05-03T15:33:31.244066Z\"}' execution_count=62}\n``` {.python .cell-code}\n# Sum of the keeps :)\nxid_partition = Window.partitionBy('xid')\nsum_keep = func.sum(col('keep')).over(xid_partition)\ndf = df.withColumn('sum_keep', sum_keep)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[61], line 4</span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> xid_partition <span style=\"color:rgb(98,98,98)\">=</span> Window<span style=\"color:rgb(98,98,98)\">.</span>partitionBy(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">xid</span><span style=\"color:rgb(175,0,0)\">'</span>)\n<span class=\"ansi-green-fg ansi-bold\">      3</span> sum_keep <span style=\"color:rgb(98,98,98)\">=</span> func<span style=\"color:rgb(98,98,98)\">.</span>sum(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">keep</span><span style=\"color:rgb(175,0,0)\">'</span>))<span style=\"color:rgb(98,98,98)\">.</span>over(xid_partition)\n<span class=\"ansi-green-fg\">----&gt; 4</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">sum_keep</span><span style=\"color:rgb(175,0,0)\">'</span>, sum_keep)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#1e288bde .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:31.467139Z\",\"start_time\":\"2020-05-03T15:33:31.404561Z\"}' execution_count=63}\n``` {.python .cell-code}\n# Let's keep the xid exposed to 1204\ndf = df.where(col('sum_keep') > 0)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[62], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># Let's keep the xid exposed to 1204</span>\n<span class=\"ansi-green-fg\">----&gt; 2</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>where(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">sum_keep</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">&gt;</span> <span style=\"color:rgb(98,98,98)\">0</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#ecad97b2 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:34.619928Z\",\"start_time\":\"2020-05-03T15:33:31.572475Z\"}' execution_count=64}\n``` {.python .cell-code}\ndf.count()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[63], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>count()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#8a8ca37e .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:37.918500Z\",\"start_time\":\"2020-05-03T15:33:34.622711Z\"}' execution_count=65}\n``` {.python .cell-code}\ndf.select('xid').distinct().count()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[64], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>select(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">xid</span><span style=\"color:rgb(175,0,0)\">'</span>)<span style=\"color:rgb(98,98,98)\">.</span>distinct()<span style=\"color:rgb(98,98,98)\">.</span>count()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#402047ca .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:52.607777Z\",\"start_time\":\"2020-05-03T15:33:40.110545Z\"}' execution_count=66}\n``` {.python .cell-code}\nrow_partition = Window().orderBy('row')\ncol_partition = Window().orderBy('col')\nrow_new = func.dense_rank().over(row_partition)\ncol_new = func.dense_rank().over(col_partition)\ndf = df.withColumn('row_new', row_new)\ndf = df.withColumn('col_new', col_new)\ncsr_data = df.select('row_new', 'col_new', 'value').toPandas()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[65], line 5</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> row_new <span style=\"color:rgb(98,98,98)\">=</span> func<span style=\"color:rgb(98,98,98)\">.</span>dense_rank()<span style=\"color:rgb(98,98,98)\">.</span>over(row_partition)\n<span class=\"ansi-green-fg ansi-bold\">      4</span> col_new <span style=\"color:rgb(98,98,98)\">=</span> func<span style=\"color:rgb(98,98,98)\">.</span>dense_rank()<span style=\"color:rgb(98,98,98)\">.</span>over(col_partition)\n<span class=\"ansi-green-fg\">----&gt; 5</span> df <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">row_new</span><span style=\"color:rgb(175,0,0)\">'</span>, row_new)\n<span class=\"ansi-green-fg ansi-bold\">      6</span> df <span style=\"color:rgb(98,98,98)\">=</span> df<span style=\"color:rgb(98,98,98)\">.</span>withColumn(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">col_new</span><span style=\"color:rgb(175,0,0)\">'</span>, col_new)\n<span class=\"ansi-green-fg ansi-bold\">      7</span> csr_data <span style=\"color:rgb(98,98,98)\">=</span> df<span style=\"color:rgb(98,98,98)\">.</span>select(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">row_new</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">col_new</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">value</span><span style=\"color:rgb(175,0,0)\">'</span>)<span style=\"color:rgb(98,98,98)\">.</span>toPandas()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#83811084 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:52.617724Z\",\"start_time\":\"2020-05-03T15:33:52.609488Z\"}' execution_count=67}\n``` {.python .cell-code}\ncsr_data.head()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[66], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">csr_data</span><span style=\"color:rgb(98,98,98)\">.</span>head()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'csr_data' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#582753b3 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:33:58.443120Z\",\"start_time\":\"2020-05-03T15:33:52.619858Z\"}' execution_count=68}\n``` {.python .cell-code}\nfeatures_names = df.select('feature_name', 'col_new').distinct()\nfeatures_names.where(col('feature_name') == 'n_actions_per_category_id#C#1204.0').head()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[67], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> features_names <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>select(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">feature_name</span><span style=\"color:rgb(175,0,0)\">'</span>, <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">col_new</span><span style=\"color:rgb(175,0,0)\">'</span>)<span style=\"color:rgb(98,98,98)\">.</span>distinct()\n<span class=\"ansi-green-fg ansi-bold\">      2</span> features_names<span style=\"color:rgb(98,98,98)\">.</span>where(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">feature_name</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">==</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_actions_per_category_id#C#1204.0</span><span style=\"color:rgb(175,0,0)\">'</span>)<span style=\"color:rgb(98,98,98)\">.</span>head()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#4b74127f .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:34:04.104342Z\",\"start_time\":\"2020-05-03T15:33:58.445504Z\"}' execution_count=69}\n``` {.python .cell-code}\nfeatures_names.where(col('feature_name') == 'n_actions_per_category_id#O#1204.0').head()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[68], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">features_names</span><span style=\"color:rgb(98,98,98)\">.</span>where(col(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">feature_name</span><span style=\"color:rgb(175,0,0)\">'</span>) <span style=\"color:rgb(98,98,98)\">==</span> <span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">n_actions_per_category_id#O#1204.0</span><span style=\"color:rgb(175,0,0)\">'</span>)<span style=\"color:rgb(98,98,98)\">.</span>head()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'features_names' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#c23c9556 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:34:11.510538Z\",\"start_time\":\"2020-05-03T15:34:11.454802Z\"}' execution_count=70}\n``` {.python .cell-code}\nfrom scipy.sparse import csr_matrix\nimport numpy as np\n\nrows = csr_data['row_new'].values - 1\ncols = csr_data['col_new'].values - 1\nvals = csr_data['value'].values\n\nX_csr = csr_matrix((vals, (rows, cols)))\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[69], line 4</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">scipy</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">sparse</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> csr_matrix\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">numpy</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">as</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">np</span>\n<span class=\"ansi-green-fg\">----&gt; 4</span> rows <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">csr_data</span>[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">row_new</span><span style=\"color:rgb(175,0,0)\">'</span>]<span style=\"color:rgb(98,98,98)\">.</span>values <span style=\"color:rgb(98,98,98)\">-</span> <span style=\"color:rgb(98,98,98)\">1</span>\n<span class=\"ansi-green-fg ansi-bold\">      5</span> cols <span style=\"color:rgb(98,98,98)\">=</span> csr_data[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">col_new</span><span style=\"color:rgb(175,0,0)\">'</span>]<span style=\"color:rgb(98,98,98)\">.</span>values <span style=\"color:rgb(98,98,98)\">-</span> <span style=\"color:rgb(98,98,98)\">1</span>\n<span class=\"ansi-green-fg ansi-bold\">      6</span> vals <span style=\"color:rgb(98,98,98)\">=</span> csr_data[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">value</span><span style=\"color:rgb(175,0,0)\">'</span>]<span style=\"color:rgb(98,98,98)\">.</span>values\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'csr_data' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#80a19859 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:34:11.977267Z\",\"start_time\":\"2020-05-03T15:34:11.972602Z\"}' execution_count=71}\n``` {.python .cell-code}\nX_csr.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[70], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">X_csr</span><span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X_csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#3c21bdde .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:34:28.207343Z\",\"start_time\":\"2020-05-03T15:34:28.202443Z\"}' execution_count=72}\n``` {.python .cell-code}\nX_csr.shape, X_csr.nnz\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[71], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">X_csr</span><span style=\"color:rgb(98,98,98)\">.</span>shape, X_csr<span style=\"color:rgb(98,98,98)\">.</span>nnz\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X_csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#f8569cf1 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:34:30.978599Z\",\"start_time\":\"2020-05-03T15:34:30.972909Z\"}' execution_count=73}\n``` {.python .cell-code}\nX_csr.nnz / (X_csr.shape[0]* X_csr.shape[1])   # 0152347 * 92)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[72], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">X_csr</span><span style=\"color:rgb(98,98,98)\">.</span>nnz <span style=\"color:rgb(98,98,98)\">/</span> (X_csr<span style=\"color:rgb(98,98,98)\">.</span>shape[<span style=\"color:rgb(98,98,98)\">0</span>]<span style=\"color:rgb(98,98,98)\">*</span> X_csr<span style=\"color:rgb(98,98,98)\">.</span>shape[<span style=\"color:rgb(98,98,98)\">1</span>])   <span style=\"font-style:italic;color:rgb(95,135,135)\"># 0152347 * 92)</span>\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X_csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#9b72e048 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:34:32.871960Z\",\"start_time\":\"2020-05-03T15:34:32.860482Z\"}' execution_count=74}\n``` {.python .cell-code}\n# The label vector. Let's make it dense, flat and binary\ny = np.array(X_csr[:, 1].todense()).ravel()\ny = np.array(y > 0, dtype=np.int64)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[73], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># The label vector. Let's make it dense, flat and binary</span>\n<span class=\"ansi-green-fg\">----&gt; 2</span> y <span style=\"color:rgb(98,98,98)\">=</span> np<span style=\"color:rgb(98,98,98)\">.</span>array(<span class=\"ansi-yellow-bg\">X_csr</span>[:, <span style=\"color:rgb(98,98,98)\">1</span>]<span style=\"color:rgb(98,98,98)\">.</span>todense())<span style=\"color:rgb(98,98,98)\">.</span>ravel()\n<span class=\"ansi-green-fg ansi-bold\">      3</span> y <span style=\"color:rgb(98,98,98)\">=</span> np<span style=\"color:rgb(98,98,98)\">.</span>array(y <span style=\"color:rgb(98,98,98)\">&gt;</span> <span style=\"color:rgb(98,98,98)\">0</span>, dtype<span style=\"color:rgb(98,98,98)\">=</span>np<span style=\"color:rgb(98,98,98)\">.</span>int64)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X_csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#140508dd .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:34:33.348181Z\",\"start_time\":\"2020-05-03T15:34:33.343110Z\"}' execution_count=75}\n``` {.python .cell-code}\nX_csr.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[74], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">X_csr</span><span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X_csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#1c593bb8 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:34:37.382059Z\",\"start_time\":\"2020-05-03T15:34:37.371588Z\"}' execution_count=76}\n``` {.python .cell-code}\n# We remove the second and fourth column. \n# It actually contain the label we'll want to predict.\nkept_cols = list(range(X_csr.shape[1]))\nkept_cols.pop(1)\nkept_cols.pop(2)\nX = X_csr[:, kept_cols]\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[75], line 3</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># We remove the second and fourth column. </span>\n<span class=\"ansi-green-fg ansi-bold\">      2</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># It actually contain the label we'll want to predict.</span>\n<span class=\"ansi-green-fg\">----&gt; 3</span> kept_cols <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">list</span>(<span style=\"color:rgb(0,135,0)\">range</span>(<span class=\"ansi-yellow-bg\">X_csr</span><span style=\"color:rgb(98,98,98)\">.</span>shape[<span style=\"color:rgb(98,98,98)\">1</span>]))\n<span class=\"ansi-green-fg ansi-bold\">      4</span> kept_cols<span style=\"color:rgb(98,98,98)\">.</span>pop(<span style=\"color:rgb(98,98,98)\">1</span>)\n<span class=\"ansi-green-fg ansi-bold\">      5</span> kept_cols<span style=\"color:rgb(98,98,98)\">.</span>pop(<span style=\"color:rgb(98,98,98)\">2</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X_csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#404bdf60 .cell execution_count=77}\n``` {.python .cell-code}\nlen(kept_cols)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[76], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"color:rgb(0,135,0)\">len</span>(<span class=\"ansi-yellow-bg\">kept_cols</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'kept_cols' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#b9f6bec5 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:34:38.375629Z\",\"start_time\":\"2020-05-03T15:34:38.369734Z\"}' execution_count=78}\n``` {.python .cell-code}\nX_csr.shape, X.shape\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[77], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">X_csr</span><span style=\"color:rgb(98,98,98)\">.</span>shape, X<span style=\"color:rgb(98,98,98)\">.</span>shape\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X_csr' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n## Finally !!\n\nWow ! That was a lot of work. Now we have a features matrix $X$ and a vector of labels $y$.\n\n::: {#0052c937 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:34:40.526092Z\",\"start_time\":\"2020-05-03T15:34:40.521420Z\"}' execution_count=79}\n``` {.python .cell-code}\nX.indices\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[78], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">X</span><span style=\"color:rgb(98,98,98)\">.</span>indices\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#3bd0d51b .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:34:40.750471Z\",\"start_time\":\"2020-05-03T15:34:40.744670Z\"}' execution_count=80}\n``` {.python .cell-code}\nX.indptr\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[79], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">X</span><span style=\"color:rgb(98,98,98)\">.</span>indptr\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#43f5342c .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:34:40.974359Z\",\"start_time\":\"2020-05-03T15:34:40.969638Z\"}' execution_count=81}\n``` {.python .cell-code}\nX.shape, X.nnz\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[80], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">X</span><span style=\"color:rgb(98,98,98)\">.</span>shape, X<span style=\"color:rgb(98,98,98)\">.</span>nnz\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#88f51d35 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:34:41.220722Z\",\"start_time\":\"2020-05-03T15:34:41.213466Z\"}' execution_count=82}\n``` {.python .cell-code}\ny.shape, y.sum()\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[81], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">y</span><span style=\"color:rgb(98,98,98)\">.</span>shape, y<span style=\"color:rgb(98,98,98)\">.</span>sum()\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'y' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n# Some learning for/from this data\n\n::: {#d0f53fc9 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:51:21.964565Z\",\"start_time\":\"2020-05-03T15:51:20.939544Z\"}' execution_count=83}\n``` {.python .cell-code}\nfrom sklearn.preprocessing import MaxAbsScaler\nfrom sklearn.model_selection import train_test_split\nfrom sklearn.linear_model import LogisticRegression\n\n# Normalize the features\nX = MaxAbsScaler().fit_transform(X)\nX_train, X_test, y_train, y_test = train_test_split(X, y, stratify=y, test_size=0.3)\n\nclf = LogisticRegression(\n    penalty='l2',\n    C=1e3,\n    solver='lbfgs',\n    class_weight='balanced'\n)\n\nclf.fit(X_train, y_train)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[82], line 6</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">sklearn</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">linear_model</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> LogisticRegression\n<span class=\"ansi-green-fg ansi-bold\">      5</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># Normalize the features</span>\n<span class=\"ansi-green-fg\">----&gt; 6</span> X <span style=\"color:rgb(98,98,98)\">=</span> MaxAbsScaler()<span style=\"color:rgb(98,98,98)\">.</span>fit_transform(<span class=\"ansi-yellow-bg\">X</span>)\n<span class=\"ansi-green-fg ansi-bold\">      7</span> X_train, X_test, y_train, y_test <span style=\"color:rgb(98,98,98)\">=</span> train_test_split(X, y, stratify<span style=\"color:rgb(98,98,98)\">=</span>y, test_size<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">0.3</span>)\n<span class=\"ansi-green-fg ansi-bold\">      9</span> clf <span style=\"color:rgb(98,98,98)\">=</span> LogisticRegression(\n<span class=\"ansi-green-fg ansi-bold\">     10</span>     penalty<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">l2</span><span style=\"color:rgb(175,0,0)\">'</span>,\n<span class=\"ansi-green-fg ansi-bold\">     11</span>     C<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">1e3</span>,\n<span class=\"ansi-green-fg ansi-bold\">     12</span>     solver<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">lbfgs</span><span style=\"color:rgb(175,0,0)\">'</span>,\n<span class=\"ansi-green-fg ansi-bold\">     13</span>     class_weight<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">balanced</span><span style=\"color:rgb(175,0,0)\">'</span>\n<span class=\"ansi-green-fg ansi-bold\">     14</span> )\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'X' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#105cfa3d .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:51:22.820046Z\",\"start_time\":\"2020-05-03T15:51:22.809009Z\"}' execution_count=84}\n``` {.python .cell-code}\nfeatures_names = features_names.toPandas()['feature_name']\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[83], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> features_names <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">features_names</span><span style=\"color:rgb(98,98,98)\">.</span>toPandas()[<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">feature_name</span><span style=\"color:rgb(175,0,0)\">'</span>]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'features_names' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#a9784ab9 .cell execution_count=85}\n``` {.python .cell-code}\nfeatures_names[range(6)]\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[84], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">features_names</span>[<span style=\"color:rgb(0,135,0)\">range</span>(<span style=\"color:rgb(98,98,98)\">6</span>)]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'features_names' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#96124f4a .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:51:25.078266Z\",\"start_time\":\"2020-05-03T15:51:23.622795Z\"}' execution_count=86}\n``` {.python .cell-code}\nimport matplotlib.pyplot as plt\n%matplotlib inline\n```\n:::\n\n\n::: {#fd96601a .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:51:25.078266Z\",\"start_time\":\"2020-05-03T15:51:23.622795Z\"}' execution_count=87}\n``` {.python .cell-code}\nplt.figure(figsize=(16, 5))\nplt.stem(clf.coef_[0]) # , use_line_collection=True)\nplt.title('Logistic regression coefficients', fontsize=18)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[86], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> plt<span style=\"color:rgb(98,98,98)\">.</span>figure(figsize<span style=\"color:rgb(98,98,98)\">=</span>(<span style=\"color:rgb(98,98,98)\">16</span>, <span style=\"color:rgb(98,98,98)\">5</span>))\n<span class=\"ansi-green-fg\">----&gt; 2</span> plt<span style=\"color:rgb(98,98,98)\">.</span>stem(<span class=\"ansi-yellow-bg\">clf</span><span style=\"color:rgb(98,98,98)\">.</span>coef_[<span style=\"color:rgb(98,98,98)\">0</span>]) <span style=\"font-style:italic;color:rgb(95,135,135)\"># , use_line_collection=True)</span>\n<span class=\"ansi-green-fg ansi-bold\">      3</span> plt<span style=\"color:rgb(98,98,98)\">.</span>title(<span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">Logistic regression coefficients</span><span style=\"color:rgb(175,0,0)\">'</span>, fontsize<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">18</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'clf' is not defined</pre>\n```\n:::\n\n:::\n\n::: {.cell-output .cell-output-display}\n```\n<Figure size 1536x480 with 0 Axes>\n```\n:::\n:::\n\n\n::: {#c52ee630 .cell execution_count=88}\n``` {.python .cell-code}\nclf.coef_[0].shape[0]\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[87], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">clf</span><span style=\"color:rgb(98,98,98)\">.</span>coef_[<span style=\"color:rgb(98,98,98)\">0</span>]<span style=\"color:rgb(98,98,98)\">.</span>shape[<span style=\"color:rgb(98,98,98)\">0</span>]\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'clf' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#2646860c .cell execution_count=89}\n``` {.python .cell-code}\nlen(features_names)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[88], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span style=\"color:rgb(0,135,0)\">len</span>(<span class=\"ansi-yellow-bg\">features_names</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'features_names' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#1407d983 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:51:25.078266Z\",\"start_time\":\"2020-05-03T15:51:23.622795Z\"}' execution_count=90}\n``` {.python .cell-code}\n# We change the fontsize of minor ticks label\n_ = plt.xticks(np.arange(clf.coef_[0].shape[0]), features_names, \n           rotation='vertical', fontsize=8)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[89], line 2</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-style:italic;color:rgb(95,135,135)\"># We change the fontsize of minor ticks label</span>\n<span class=\"ansi-green-fg\">----&gt; 2</span> _ <span style=\"color:rgb(98,98,98)\">=</span> plt<span style=\"color:rgb(98,98,98)\">.</span>xticks(np<span style=\"color:rgb(98,98,98)\">.</span>arange(<span class=\"ansi-yellow-bg\">clf</span><span style=\"color:rgb(98,98,98)\">.</span>coef_[<span style=\"color:rgb(98,98,98)\">0</span>]<span style=\"color:rgb(98,98,98)\">.</span>shape[<span style=\"color:rgb(98,98,98)\">0</span>]), features_names, \n<span class=\"ansi-green-fg ansi-bold\">      3</span>            rotation<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">vertical</span><span style=\"color:rgb(175,0,0)\">'</span>, fontsize<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">8</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'clf' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#4994145b .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:51:25.078266Z\",\"start_time\":\"2020-05-03T15:51:23.622795Z\"}' execution_count=91}\n``` {.python .cell-code}\n_ = plt.yticks(fontsize=14)\n```\n\n::: {.cell-output .cell-output-display}\n![](notebook08_webdata_files/figure-html/cell-92-output-1.png){width=590 height=418}\n:::\n:::\n\n\n::: {#cad10c36 .cell ExecuteTime='{\"end_time\":\"2020-05-03T15:51:25.280157Z\",\"start_time\":\"2020-05-03T15:51:25.081464Z\"}' execution_count=92}\n``` {.python .cell-code}\nfrom sklearn.metrics import precision_recall_curve, f1_score\n\nprecision, recall, _ = precision_recall_curve(y_test, clf.predict_proba(X_test)[:, 1])\n    \nplt.figure(figsize=(8, 6))\nplt.plot(recall, precision, label='LR (F1=%.2f)' % f1_score(y_test, clf.predict(X_test)), lw=2)\nplt.xlim([0.0, 1.0])\nplt.ylim([0.0, 1.05])\nplt.xlabel('Recall', fontsize=16)\nplt.ylabel('Precision', fontsize=16)\nplt.title('Precision/recall curve', fontsize=18)\nplt.legend(loc=\"upper right\", fontsize=14)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[91], line 3</span>\n<span class=\"ansi-green-fg ansi-bold\">      1</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,0,255)\">sklearn</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">.</span><span style=\"font-weight:bold;color:rgb(0,0,255)\">metrics</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">import</span> precision_recall_curve, f1_score\n<span class=\"ansi-green-fg\">----&gt; 3</span> precision, recall, _ <span style=\"color:rgb(98,98,98)\">=</span> precision_recall_curve(<span class=\"ansi-yellow-bg\">y_test</span>, clf<span style=\"color:rgb(98,98,98)\">.</span>predict_proba(X_test)[:, <span style=\"color:rgb(98,98,98)\">1</span>])\n<span class=\"ansi-green-fg ansi-bold\">      5</span> plt<span style=\"color:rgb(98,98,98)\">.</span>figure(figsize<span style=\"color:rgb(98,98,98)\">=</span>(<span style=\"color:rgb(98,98,98)\">8</span>, <span style=\"color:rgb(98,98,98)\">6</span>))\n<span class=\"ansi-green-fg ansi-bold\">      6</span> plt<span style=\"color:rgb(98,98,98)\">.</span>plot(recall, precision, label<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(175,0,0)\">'</span><span style=\"color:rgb(175,0,0)\">LR (F1=</span><span style=\"font-weight:bold;color:rgb(175,95,135)\">%.2f</span><span style=\"color:rgb(175,0,0)\">)</span><span style=\"color:rgb(175,0,0)\">'</span> <span style=\"color:rgb(98,98,98)\">%</span> f1_score(y_test, clf<span style=\"color:rgb(98,98,98)\">.</span>predict(X_test)), lw<span style=\"color:rgb(98,98,98)\">=</span><span style=\"color:rgb(98,98,98)\">2</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'y_test' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n# Analyse the tables \n\n::: {#10bdc6f2 .cell execution_count=93}\n``` {.python .cell-code}\nquery = \"\"\"ANALYZE TABLE db_table COMPUTE STATISTICS\n            FOR COLUMNS xid\"\"\"\n```\n:::\n\n\n::: {#5b0c52e5 .cell execution_count=94}\n``` {.python .cell-code}\ndf.createOrReplaceTempView(\"db_table\")\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[93], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>createOrReplaceTempView(<span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">db_table</span><span style=\"color:rgb(175,0,0)\">\"</span>)\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#88e759b9 .cell execution_count=95}\n``` {.python .cell-code}\ndf.columns\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">NameError</span>                                 Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[94], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">df</span><span style=\"color:rgb(98,98,98)\">.</span>columns\n\n<span class=\"ansi-red-fg\">NameError</span>: name 'df' is not defined</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#ce6c7a89 .cell execution_count=96}\n``` {.python .cell-code}\nspark.sql(\"cache table db_table\")\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">AnalysisException</span>                         Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[95], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">spark</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">sql</span><span class=\"ansi-yellow-bg\">(</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">\"</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">cache table db_table</span><span style=\"color:rgb(175,0,0)\" class=\"ansi-yellow-bg\">\"</span><span class=\"ansi-yellow-bg\">)</span>\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyspark/sql/session.py:1631</span>, in <span class=\"ansi-cyan-fg\">SparkSession.sql</span><span class=\"ansi-blue-fg\">(self, sqlQuery, args, **kwargs)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1627</span>         <span style=\"font-weight:bold;color:rgb(0,135,0)\">assert</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_jvm <span style=\"font-weight:bold;color:rgb(175,0,255)\">is</span> <span style=\"font-weight:bold;color:rgb(175,0,255)\">not</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>\n<span class=\"ansi-green-fg ansi-bold\">   1628</span>         litArgs <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_jvm<span style=\"color:rgb(98,98,98)\">.</span>PythonUtils<span style=\"color:rgb(98,98,98)\">.</span>toArray(\n<span class=\"ansi-green-fg ansi-bold\">   1629</span>             [_to_java_column(lit(v)) <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> v <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> (args <span style=\"font-weight:bold;color:rgb(175,0,255)\">or</span> [])]\n<span class=\"ansi-green-fg ansi-bold\">   1630</span>         )\n<span class=\"ansi-green-fg\">-&gt; 1631</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> DataFrame(<span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_jsparkSession</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">sql</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">sqlQuery</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span class=\"ansi-yellow-bg\">litArgs</span><span class=\"ansi-yellow-bg\">)</span>, <span style=\"color:rgb(0,135,0)\">self</span>)\n<span class=\"ansi-green-fg ansi-bold\">   1632</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">finally</span>:\n<span class=\"ansi-green-fg ansi-bold\">   1633</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">len</span>(kwargs) <span style=\"color:rgb(98,98,98)\">&gt;</span> <span style=\"color:rgb(98,98,98)\">0</span>:\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/py4j/java_gateway.py:1322</span>, in <span class=\"ansi-cyan-fg\">JavaMember.__call__</span><span class=\"ansi-blue-fg\">(self, *args)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1316</span> command <span style=\"color:rgb(98,98,98)\">=</span> proto<span style=\"color:rgb(98,98,98)\">.</span>CALL_COMMAND_NAME <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1317</span>     <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>command_header <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1318</span>     args_command <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1319</span>     proto<span style=\"color:rgb(98,98,98)\">.</span>END_COMMAND_PART\n<span class=\"ansi-green-fg ansi-bold\">   1321</span> answer <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>gateway_client<span style=\"color:rgb(98,98,98)\">.</span>send_command(command)\n<span class=\"ansi-green-fg\">-&gt; 1322</span> return_value <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">get_return_value</span><span class=\"ansi-yellow-bg\">(</span>\n<span class=\"ansi-green-fg ansi-bold\">   1323</span> <span class=\"ansi-yellow-bg\">    </span><span class=\"ansi-yellow-bg\">answer</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">gateway_client</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">target_id</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">name</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1325</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> temp_arg <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> temp_args:\n<span class=\"ansi-green-fg ansi-bold\">   1326</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">hasattr</span>(temp_arg, <span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">_detach</span><span style=\"color:rgb(175,0,0)\">\"</span>):\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyspark/errors/exceptions/captured.py:185</span>, in <span class=\"ansi-cyan-fg\">capture_sql_exception.&lt;locals&gt;.deco</span><span class=\"ansi-blue-fg\">(*a, **kw)</span>\n<span class=\"ansi-green-fg ansi-bold\">    181</span> converted <span style=\"color:rgb(98,98,98)\">=</span> convert_exception(e<span style=\"color:rgb(98,98,98)\">.</span>java_exception)\n<span class=\"ansi-green-fg ansi-bold\">    182</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"font-weight:bold;color:rgb(175,0,255)\">not</span> <span style=\"color:rgb(0,135,0)\">isinstance</span>(converted, UnknownException):\n<span class=\"ansi-green-fg ansi-bold\">    183</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># Hide where the exception came from that shows a non-Pythonic</span>\n<span class=\"ansi-green-fg ansi-bold\">    184</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># JVM exception message.</span>\n<span class=\"ansi-green-fg\">--&gt; 185</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span> converted <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>\n<span class=\"ansi-green-fg ansi-bold\">    186</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">else</span>:\n<span class=\"ansi-green-fg ansi-bold\">    187</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span>\n\n<span class=\"ansi-red-fg\">AnalysisException</span>: [TABLE_OR_VIEW_NOT_FOUND] The table or view `db_table` cannot be found. Verify the spelling and correctness of the schema and catalog.\nIf you did not qualify the name with a schema, verify the current_schema() output, or qualify the name with the correct schema and catalog.\nTo tolerate the error on drop use DROP VIEW IF EXISTS or DROP TABLE IF EXISTS.; line 1 pos 12;\n'CacheTable [db_table], false, false\n+- 'UnresolvedRelation [db_table], [], false\n</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#c0097e06 .cell execution_count=97}\n``` {.python .cell-code}\nspark.sql(query)\n```\n\n::: {.cell-output .cell-output-error}\n\n::: {.ansi-escaped-output}\n```{=html}\n<pre><span class=\"ansi-red-fg\">---------------------------------------------------------------------------</span>\n<span class=\"ansi-red-fg\">AnalysisException</span>                         Traceback (most recent call last)\nCell <span class=\"ansi-green-fg\">In[96], line 1</span>\n<span class=\"ansi-green-fg\">----&gt; 1</span> <span class=\"ansi-yellow-bg\">spark</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">sql</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">query</span><span class=\"ansi-yellow-bg\">)</span>\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyspark/sql/session.py:1631</span>, in <span class=\"ansi-cyan-fg\">SparkSession.sql</span><span class=\"ansi-blue-fg\">(self, sqlQuery, args, **kwargs)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1627</span>         <span style=\"font-weight:bold;color:rgb(0,135,0)\">assert</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_jvm <span style=\"font-weight:bold;color:rgb(175,0,255)\">is</span> <span style=\"font-weight:bold;color:rgb(175,0,255)\">not</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>\n<span class=\"ansi-green-fg ansi-bold\">   1628</span>         litArgs <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>_jvm<span style=\"color:rgb(98,98,98)\">.</span>PythonUtils<span style=\"color:rgb(98,98,98)\">.</span>toArray(\n<span class=\"ansi-green-fg ansi-bold\">   1629</span>             [_to_java_column(lit(v)) <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> v <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> (args <span style=\"font-weight:bold;color:rgb(175,0,255)\">or</span> [])]\n<span class=\"ansi-green-fg ansi-bold\">   1630</span>         )\n<span class=\"ansi-green-fg\">-&gt; 1631</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">return</span> DataFrame(<span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">_jsparkSession</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">sql</span><span class=\"ansi-yellow-bg\">(</span><span class=\"ansi-yellow-bg\">sqlQuery</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span class=\"ansi-yellow-bg\">litArgs</span><span class=\"ansi-yellow-bg\">)</span>, <span style=\"color:rgb(0,135,0)\">self</span>)\n<span class=\"ansi-green-fg ansi-bold\">   1632</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">finally</span>:\n<span class=\"ansi-green-fg ansi-bold\">   1633</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">len</span>(kwargs) <span style=\"color:rgb(98,98,98)\">&gt;</span> <span style=\"color:rgb(98,98,98)\">0</span>:\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/py4j/java_gateway.py:1322</span>, in <span class=\"ansi-cyan-fg\">JavaMember.__call__</span><span class=\"ansi-blue-fg\">(self, *args)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1316</span> command <span style=\"color:rgb(98,98,98)\">=</span> proto<span style=\"color:rgb(98,98,98)\">.</span>CALL_COMMAND_NAME <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1317</span>     <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>command_header <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1318</span>     args_command <span style=\"color:rgb(98,98,98)\">+</span>\\\n<span class=\"ansi-green-fg ansi-bold\">   1319</span>     proto<span style=\"color:rgb(98,98,98)\">.</span>END_COMMAND_PART\n<span class=\"ansi-green-fg ansi-bold\">   1321</span> answer <span style=\"color:rgb(98,98,98)\">=</span> <span style=\"color:rgb(0,135,0)\">self</span><span style=\"color:rgb(98,98,98)\">.</span>gateway_client<span style=\"color:rgb(98,98,98)\">.</span>send_command(command)\n<span class=\"ansi-green-fg\">-&gt; 1322</span> return_value <span style=\"color:rgb(98,98,98)\">=</span> <span class=\"ansi-yellow-bg\">get_return_value</span><span class=\"ansi-yellow-bg\">(</span>\n<span class=\"ansi-green-fg ansi-bold\">   1323</span> <span class=\"ansi-yellow-bg\">    </span><span class=\"ansi-yellow-bg\">answer</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">gateway_client</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">target_id</span><span class=\"ansi-yellow-bg\">,</span><span class=\"ansi-yellow-bg\"> </span><span style=\"color:rgb(0,135,0)\" class=\"ansi-yellow-bg\">self</span><span style=\"color:rgb(98,98,98)\" class=\"ansi-yellow-bg\">.</span><span class=\"ansi-yellow-bg\">name</span><span class=\"ansi-yellow-bg\">)</span>\n<span class=\"ansi-green-fg ansi-bold\">   1325</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">for</span> temp_arg <span style=\"font-weight:bold;color:rgb(175,0,255)\">in</span> temp_args:\n<span class=\"ansi-green-fg ansi-bold\">   1326</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"color:rgb(0,135,0)\">hasattr</span>(temp_arg, <span style=\"color:rgb(175,0,0)\">\"</span><span style=\"color:rgb(175,0,0)\">_detach</span><span style=\"color:rgb(175,0,0)\">\"</span>):\n\nFile <span class=\"ansi-green-fg\">~/Documents/IFEBY310/.venv/lib/python3.12/site-packages/pyspark/errors/exceptions/captured.py:185</span>, in <span class=\"ansi-cyan-fg\">capture_sql_exception.&lt;locals&gt;.deco</span><span class=\"ansi-blue-fg\">(*a, **kw)</span>\n<span class=\"ansi-green-fg ansi-bold\">    181</span> converted <span style=\"color:rgb(98,98,98)\">=</span> convert_exception(e<span style=\"color:rgb(98,98,98)\">.</span>java_exception)\n<span class=\"ansi-green-fg ansi-bold\">    182</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">if</span> <span style=\"font-weight:bold;color:rgb(175,0,255)\">not</span> <span style=\"color:rgb(0,135,0)\">isinstance</span>(converted, UnknownException):\n<span class=\"ansi-green-fg ansi-bold\">    183</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># Hide where the exception came from that shows a non-Pythonic</span>\n<span class=\"ansi-green-fg ansi-bold\">    184</span>     <span style=\"font-style:italic;color:rgb(95,135,135)\"># JVM exception message.</span>\n<span class=\"ansi-green-fg\">--&gt; 185</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span> converted <span style=\"font-weight:bold;color:rgb(0,135,0)\">from</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">None</span>\n<span class=\"ansi-green-fg ansi-bold\">    186</span> <span style=\"font-weight:bold;color:rgb(0,135,0)\">else</span>:\n<span class=\"ansi-green-fg ansi-bold\">    187</span>     <span style=\"font-weight:bold;color:rgb(0,135,0)\">raise</span>\n\n<span class=\"ansi-red-fg\">AnalysisException</span>: [TABLE_OR_VIEW_NOT_FOUND] The table or view `db_table` cannot be found. Verify the spelling and correctness of the schema and catalog.\nIf you did not qualify the name with a schema, verify the current_schema() output, or qualify the name with the correct schema and catalog.\nTo tolerate the error on drop use DROP VIEW IF EXISTS or DROP TABLE IF EXISTS.; line 1 pos 14;\n'AnalyzeColumn ArrayBuffer(xid), false\n+- 'UnresolvedTableOrView [db_table], ANALYZE TABLE ... FOR COLUMNS ..., true\n</pre>\n```\n:::\n\n:::\n:::\n\n\n::: {#eea3422b .cell execution_count=98}\n``` {.python .cell-code}\nspark.sql(\"show tables\")\n```\n\n::: {.cell-output .cell-output-display execution_count=97}\n```\nDataFrame[namespace: string, tableName: string, isTemporary: boolean]\n```\n:::\n:::\n\n\n",
    "supporting": [
      "notebook08_webdata_files"
    ],
    "filters": [],
    "includes": {}
  }
}